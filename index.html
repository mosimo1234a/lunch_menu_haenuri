<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>í•´ëˆ„ë¦¬ ì´ˆë“±í•™êµ 5í•™ë…„ ìš°ë¦¬ë“¤ì˜ ê³µê°„ ğŸ«ğŸ„</title>
<link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
<style>
    :root {
        --color-apricot: #ffd9a8; --color-sky: #a8d5ff; --color-rose: #ffc9d4;
        --color-grass: #d2f6c9; --color-text-dark: #3a322b; 
        --color-card-bg: #ffffff; --color-border: #3a322b;
        --color-gold: #FFD700;
    }

    body {
        font-family: 'Jua', sans-serif;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        min-height: 100vh; margin: 0; background-color: var(--color-sky); color: var(--color-text-dark);
        background-image: 
            radial-gradient(circle at 50% 50%, white 2.5px, transparent 2.5px),
            radial-gradient(circle at 20% 80%, white 3.5px, transparent 3.5px),
            radial-gradient(circle at 80% 10%, white 3px, transparent 3px);
        background-size: 150px 150px, 250px 250px, 200px 200px;
        animation: snow-animation 12s linear infinite;
        overflow-x: hidden;
    }
    @keyframes snow-animation {
        0% { background-position: 0 0, 0 0, 0 0; }
        100% { background-position: 60px 1000px, -60px 1000px, 40px 1000px; }
    }

    .card {
        background-color: var(--color-card-bg); border-radius: 35px; padding: 35px;
        border: 4px dashed var(--color-border); box-shadow: 6px 6px 0 0 var(--color-border);
        text-align: center; width: 92%; max-width: 400px; transform: rotate(-3deg);
        box-sizing: border-box; position: relative; margin: 15px;
    }
    p { font-size: 2rem; font-weight: bold; margin-bottom: 25px; line-height: 1.2; }
    
    #user-info-display {
        font-size: 1.2rem; color: #333; margin-bottom: 10px;
        background-color: #fff8e1; border-radius: 15px; padding: 10px;
        border: 2.5px solid var(--color-gold); transform: rotate(1deg);
    }
    .title-badge { display: inline-block; padding: 2px 10px; border-radius: 10px; background-color: #333; color: var(--color-gold); font-size: 0.85rem; margin-top: 5px; }

    #xp-bar-container {
        width: 100%; height: 18px; background-color: #eee; border-radius: 10px;
        margin-bottom: 25px; overflow: hidden; border: 2px solid var(--color-border);
        position: relative; box-shadow: 2px 2px 0 0 var(--color-border);
    }
    #xp-bar { height: 100%; width: 0%; background-color: var(--color-gold); transition: width 0.6s; }
    #xp-text { position: absolute; width: 100%; text-align: center; line-height: 18px; font-size: 0.8rem; font-weight: bold; }

    button {
        font-family: 'Jua', sans-serif; font-weight: bold; font-size: 1.1rem;
        padding: 12px 15px; margin: 6px 0; border-radius: 30px; border: 4px solid var(--color-border);
        cursor: pointer; background-color: #fff; width: 100%; transition: 0.1s;
        box-shadow: 4px 4px 0px 0px var(--color-border); transform: rotate(2deg);
    }
    button:active { transform: scale(0.96) rotate(1deg); box-shadow: 2px 2px 0px 0px var(--color-border); }

    /* ëŒë¦¼íŒ UI */
    #roulette-wrap { position: relative; width: 220px; height: 220px; margin: 15px auto; }
    #roulette {
        width: 100%; height: 100%; border-radius: 50%; border: 4px solid var(--color-border);
        background: conic-gradient(#ffadad 0% 10%, #ffd6a5 10% 30%, #fff9c4 30% 60%, #caffbf 60% 85%, #9bf6ff 85% 95%, var(--color-gold) 95% 100%);
        transition: transform 4s cubic-bezier(0.15, 0, 0.15, 1);
    }
    #roulette-pin { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 12px solid transparent; border-right: 12px solid transparent; border-top: 25px solid #ff4444; z-index: 5; }

    #game-area { width: 100%; height: 160px; background-color: #e0f2ff; border: 3px solid var(--color-border); border-radius: 20px; position: relative; overflow: hidden; margin-bottom: 15px; }
    #thief { position: absolute; font-size: 3rem; cursor: pointer; display: none; user-select: none; }
    
    #menu_table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    #menu_table td { border: 1px solid var(--color-border); padding: 8px; text-align: center; }
    .hidden { display: none !important; }
</style>
</head>
<body>

<div id="question" class="card">
    <p>í•´ëˆ„ë¦¬ ì´ˆë“±í•™êµ í•™ìƒì…ë‹ˆê¹Œ? ğŸ</p>
    <button id="yes_btn" style="background-color: var(--color-rose); transform: rotate(-3deg);">ë„¤! ë§ìŠµë‹ˆë‹¤! ğŸ¥³</button>
    <button onclick="alert('ë°˜ê°€ì› ì–´ìš”!')" style="background-color: var(--color-grass);">ì•„ë‹™ë‹ˆë‹¤ ğŸ˜¥</button>
</div>

<div id="portal" class="card hidden">
    <div id="user-info-display"></div>
    <div id="xp-bar-container"><div id="xp-bar"></div><div id="xp-text"></div></div>
    
    <button onclick="StateManager.loadData('meal')" style="background-color: var(--color-rose); transform: rotate(-2deg);">ê¸‰ì‹ ë©”ë‰´ ğŸš</button>
    <button onclick="StateManager.loadData('timetable')" style="background-color: #cceeff; transform: rotate(-1deg);">ì˜¤ëŠ˜ ì‹œê°„í‘œ â°</button>
    <button onclick="StateManager.showScreen('roulette-screen')" style="background-color: var(--color-gold); transform: rotate(1deg);">í–‰ìš´ì˜ ëŒë¦¼íŒ (5íšŒ) ğŸ¡</button>
    <button id="title-list-btn" onclick="showTitleList()" style="background-color: #e1f5fe; transform: rotate(-2deg);">ë‚˜ì˜ ì¹­í˜¸ ëª©ë¡ ğŸ–ï¸</button>
    <button onclick="StateManager.showScreen('minigame-screen')" style="background-color: var(--color-apricot); transform: rotate(3deg);">ì„ ë¬¼ í›”ì¹˜ê¸° ê²Œì„ ğŸ®</button>
    
    <button id="inquiry-btn" class="hidden" onclick="StateManager.showScreen('inquiry-screen')" style="background-color: #e1bee7;">ìš´ì˜ì ë¬¸ì˜ âœ‰ï¸</button>
    <button onclick="promptForSettings()" style="font-size: 0.8rem; width: auto; margin-top: 15px; border-width: 2px;">ì •ë³´ ì„¤ì • âš™ï¸</button>
</div>

<div id="roulette-screen" class="card hidden">
    <p style="font-size: 1.5rem;">ğŸ¡ í–‰ìš´ì˜ ë£°ë ›</p>
    <p id="chance-text" style="font-size: 1rem; color: #ff5252; margin-top:-15px;">ë‚¨ì€ ê¸°íšŒ: 5ë²ˆ</p>
    <div id="roulette-wrap"><div id="roulette-pin"></div><div id="roulette"></div></div>
    <button id="spin-btn" onclick="spinRoulette()" style="background-color: #ff5252; color: white;">ëŒë¦¬ê¸°!! ğŸš€</button>
    <button onclick="StateManager.showScreen('portal')">ëŒì•„ê°€ê¸°</button>
</div>

<div id="message_area" class="card hidden">
    <p id="display-title" style="font-size: 1.5rem;"></p>
    <div style="max-height: 250px; overflow-y: auto; background: white; border-radius: 15px;"><table id="menu_table"></table></div>
    <button onclick="StateManager.showScreen('portal')" style="margin-top:15px;">ë’¤ë¡œ ê°€ê¸°</button>
</div>

<div id="minigame-screen" class="card hidden">
    <p style="font-size: 1.5rem;">ğŸ ì„ ë¬¼ í›”ì¹˜ê¸°</p>
    <div id="game-area"><span id="thief">ğŸ…</span></div>
    <p id="game-score" style="font-size: 1.2rem; color: var(--color-rose);">ì ìˆ˜: 0ì </p>
    <button id="start-game-btn" onclick="startThiefGame()" style="background-color: var(--color-sky);">ê²Œì„ ì‹œì‘!</button>
    <button onclick="StateManager.showScreen('portal')">ê·¸ë§Œí•˜ê¸°</button>
</div>

<div id="title-screen" class="card hidden">
    <p style="font-size: 1.5rem;">ğŸ–ï¸ ë‚˜ì˜ ì¹­í˜¸</p>
    <div id="title-container" style="max-height: 250px; overflow-y: auto; text-align: left; padding: 10px;"></div>
    <button onclick="StateManager.showScreen('portal')" style="margin-top:15px;">ë‹«ê¸°</button>
</div>

<div id="inquiry-screen" class="card hidden">
    <p style="font-size: 1.5rem;">âœ‰ï¸ ìš´ì˜ì ë¬¸ì˜</p>
    <textarea id="inquiry-content" style="width:100%; height:100px; border:3px solid var(--color-border); border-radius:15px; padding:10px; font-family:'Jua';" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
    <button onclick="sendInquiry()" style="background-color: var(--color-rose); margin-top:10px;">ì „ì†¡í•˜ê¸° ğŸš€</button>
    <button onclick="StateManager.showScreen('portal')">ì·¨ì†Œ</button>
</div>

<script>
// --- [ë°ì´í„° ì„¤ì •] ---
const ADMIN_CONF = { g: '5', c: '5', n: '1', name: 'ê°•ë¯¼ì¤€', pw: 'minjun55' }; 
const OPERATOR_CONF = { g: '5', c: '5', n: '4', name: 'ê¹€ëŒ€ì›', pw: 'eodnjs14' }; 
const NEIS_CONF = { KEY: "59ff63a46d7f41bf97464e3caf3a486c", ATPT: "B10", SD: "7130255" };

const TITLE_DB = {
    'sprout': 'í•´ëˆ„ë¦¬ ìƒˆì‹¹ ğŸŒ±', 'explorer': 'ì •ë³´ íƒí—˜ê°€ ğŸ§­', 
    'santa': 'ğŸ… ì‚°íƒ€ì˜ ì¡°ìˆ˜', 'rudolph': 'ğŸ¦Œ ë£¨ëŒí”„ ì½”', 'gift': 'ğŸ ì„ ë¬¼ ë„ë‘‘'
};

let userName = localStorage.getItem('user_name') || '';
let userGrade = localStorage.getItem('user_grade') || '';
let userClass = localStorage.getItem('user_class') || '';
let role = localStorage.getItem('user_role') || 'user';
let myTitles = JSON.parse(localStorage.getItem('my_titles') || '["sprout"]');
let activeTitle = localStorage.getItem('active_title') || 'sprout';
let currentRot = 0;
let isSpinning = false;

// --- [UI ì—…ë°ì´íŠ¸ ë¡œì§] ---
function updateUserInfoDisplay() {
    const el = document.getElementById('user-info-display');
    const d = JSON.parse(localStorage.getItem('total_xp_ranking') || '{}');
    const xp = (d[`${userGrade}-${userClass}-${userName}`] || {}).totalXP || 0;
    
    if(userName) {
        let tag = role === 'admin' ? " [ğŸ‘‘ ê´€ë¦¬ì]" : (role === 'operator' ? " [âš™ï¸ ìš´ì˜ì]" : "");
        el.innerHTML = `${userGrade}-${userClass} ${userName}${tag}<br><div class="title-badge">${TITLE_DB[activeTitle] || 'ìƒˆì‹¹'}</div>`;
        document.getElementById('xp-bar').style.width = Math.min((xp/1000)*100, 100) + '%';
        document.getElementById('xp-text').innerText = `XP: ${xp} / 1000`;
        if(role === 'admin' || role === 'operator') document.getElementById('inquiry-btn').classList.remove('hidden');
    }
}

// --- [ëŒë¦¼íŒ ë¡œì§] ---
function spinRoulette() {
    if(isSpinning) return;
    let chances = parseInt(localStorage.getItem('chances') || '5');
    if(localStorage.getItem('last_date') !== new Date().toDateString()) chances = 5;
    if(chances <= 0) return alert("ğŸ… ê¸°íšŒë¥¼ ëª¨ë‘ ì¼ì–´ìš”. ë‚´ì¼ ë‹¤ì‹œ ì˜¤ì„¸ìš”!");

    isSpinning = true;
    chances--;
    localStorage.setItem('chances', chances);
    localStorage.setItem('last_date', new Date().toDateString());
    document.getElementById('chance-text').innerText = `ë‚¨ì€ ê¸°íšŒ: ${chances}ë²ˆ`;

    const rand = Math.random() * 100;
    let angle = rand < 10 ? 18 : (rand < 40 ? 260 : 160);
    currentRot += (360 * 5) + (360 - angle);
    document.getElementById('roulette').style.transform = `rotate(${currentRot}deg)`;

    setTimeout(() => {
        isSpinning = false;
        if(rand < 10) {
            const pick = ['santa', 'rudolph', 'gift'][Math.floor(Math.random()*3)];
            if(!myTitles.includes(pick)) { myTitles.push(pick); localStorage.setItem('my_titles', JSON.stringify(myTitles)); alert(`ğŸŠ í•œì • ì¹­í˜¸ [${TITLE_DB[pick]}] íšë“!`); }
            else { alert("100 XP íšë“!"); earnXP(100); }
        } else {
            let winXP = rand < 40 ? 50 : 10;
            alert(`âœ¨ ${winXP} XPë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!`);
            earnXP(winXP);
        }
        updateUserInfoDisplay();
    }, 4000);
}

// --- [ë¯¸ë‹ˆê²Œì„ ë¡œì§] ---
let score = 0;
function startThiefGame() {
    score = 0; document.getElementById('game-score').innerText = "ì ìˆ˜: 0ì ";
    const thief = document.getElementById('thief');
    thief.style.display = 'block';
    let timer = setInterval(() => {
        thief.style.top = Math.random() * 100 + 'px';
        thief.style.left = Math.random() * 80 + '%';
    }, 800);
    thief.onclick = () => { score++; document.getElementById('game-score').innerText = `ì ìˆ˜: ${score}ì `; };
    setTimeout(() => { clearInterval(timer); thief.style.display = 'none'; alert(`ê²Œì„ ì¢…ë£Œ! ìµœì¢… ì ìˆ˜: ${score}`); earnXP(score); }, 10000);
}

// --- [ì¹­í˜¸ ë¦¬ìŠ¤íŠ¸] ---
function showTitleList() {
    StateManager.showScreen('title-screen');
    const cont = document.getElementById('title-container');
    cont.innerHTML = "";
    myTitles.forEach(t => {
        const b = document.createElement('button');
        b.innerText = TITLE_DB[t];
        b.style = "margin: 5px 0; font-size: 0.9rem;";
        b.onclick = () => { activeTitle = t; localStorage.setItem('active_title', t); alert('ì¥ì°© ì™„ë£Œ!'); StateManager.showScreen('portal'); };
        cont.appendChild(b);
    });
}

// --- [ê³µí†µ ë¡œì§] ---
function earnXP(amt) {
    const k = `${userGrade}-${userClass}-${userName}`;
    const d = JSON.parse(localStorage.getItem('total_xp_ranking') || '{}');
    if(!d[k]) d[k] = { totalXP: 0, name: userName };
    d[k].totalXP += amt;
    localStorage.setItem('total_xp_ranking', JSON.stringify(d));
}

async function sendInquiry() {
    const content = document.getElementById('inquiry-content').value;
    if(!content) return;
    alert("ìš´ì˜ì(ê¹€ëŒ€ì›)ë‹˜ê»˜ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤! âœ…");
    StateManager.showScreen('portal');
}

const StateManager = {
    showScreen: function(id) { 
        document.querySelectorAll('.card').forEach(c => c.classList.add('hidden')); 
        document.getElementById(id).classList.remove('hidden'); 
        updateUserInfoDisplay();
    },
    loadData: async function(mode) {
        this.showScreen('message_area');
        const table = document.getElementById('menu_table');
        table.innerHTML = "<tr><td>ë¡œë”© ì¤‘...</td></tr>";
        let ymd = new Date().toISOString().split('T')[0].replace(/-/g, '');
        let url = mode === 'meal' ? `https://open.neis.go.kr/hub/mealServiceDietInfo?KEY=${NEIS_CONF.KEY}&Type=json&ATPT_OFCDC_SC_CODE=${NEIS_CONF.ATPT}&SD_SCHUL_CODE=${NEIS_CONF.SD}&MLSV_YMD=${ymd}` 
                : `https://open.neis.go.kr/hub/elsTimetable?KEY=${NEIS_CONF.KEY}&Type=json&ATPT_OFCDC_SC_CODE=${NEIS_CONF.ATPT}&SD_SCHUL_CODE=${NEIS_CONF.SD}&GRADE=${userGrade}&CLASS_NM=${userClass}&ALL_TI_YMD=${ymd}`;
        try {
            const r = await fetch(url); const d = await r.json(); table.innerHTML = "";
            if(mode === 'meal' && d.mealServiceDietInfo) {
                d.mealServiceDietInfo[1].row[0].DDISH_NM.split('<br/>').forEach(m => { table.insertRow().insertCell().innerText = m.replace(/\([0-9\.]+\)/g, ''); });
            } else if(mode === 'timetable' && d.elsTimetable) {
                d.elsTimetable[1].row.forEach(s => { let tr = table.insertRow(); tr.insertCell().innerText = s.PERIO + "êµì‹œ"; tr.insertCell().innerText = s.ITRT_CNTNT; });
            } else { table.innerHTML = "<tr><td>ì˜¤ëŠ˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>"; }
        } catch(e) { table.innerHTML = "<tr><td>ì—°ê²° ì˜¤ë¥˜ ë°œìƒ</td></tr>"; }
    }
};

function promptForSettings() {
    const g = prompt("í•™ë…„", "5"); const c = prompt("ë°˜", "5"); const n = prompt("ë²ˆí˜¸", "1"); const nm = prompt("ì´ë¦„", "ì´ë¦„");
    if(!g || !c || !n || !nm) return;
    let r = 'user';
    if(nm === ADMIN_CONF.name && prompt("ê´€ë¦¬ì ë¹„ë²ˆ") === ADMIN_CONF.pw) r = 'admin';
    else if(nm === OPERATOR_CONF.name && prompt("ìš´ì˜ì ë¹„ë²ˆ") === OPERATOR_CONF.pw) r = 'operator';
    localStorage.setItem('user_grade', g); localStorage.setItem('user_class', c);
    localStorage.setItem('user_name', nm); localStorage.setItem('user_role', r);
    location.reload();
}

document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('yes_btn').onclick = () => { if(!userName) promptForSettings(); else StateManager.showScreen('portal'); };
    if(userName) StateManager.showScreen('portal');
});
</script>
</body>
</html>
