<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>í•´ëˆ„ë¦¬ ì´ˆë“±í•™êµ 5í•™ë…„ ìš°ë¦¬ë“¤ì˜ ê³µê°„ ğŸ«</title>
<link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
<style>
    /* --- 1. CSS ë³€ìˆ˜ ë° ê¸°ë³¸ ì„¤ì • --- */
    :root {
        --color-apricot: #ffd9a8;
        --color-sky: #cceeff; --color-rose: #ffc9d4;
        --color-grass: #d2f6c9; --color-text-dark: #3a322b; 
        --color-card-bg: #ffffff; --color-border: #3a322b;
    }

    body {
        font-family: 'Jua', sans-serif;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        background-color: var(--color-apricot);
        color: var(--color-text-dark);
        background-image: url('data:image/svg+xml;utf8,<svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><circle cx="5" cy="5" r="1.5" fill="%23f6f0e9" opacity="0.8"/><path d="M15,15 L15,13 L15,11 L13,13 Z" fill="%23f6f0e9" opacity="0.6"/></svg>');
        background-size: 40px 40px;
    }

    /* --- 2. ì¹´ë“œ ë””ìì¸ --- */
    .card {
        background-color: var(--color-card-bg);
        border-radius: 35px;
        padding: 40px;
        border: 4px dashed var(--color-border);
        box-shadow: 6px 6px 0 0 var(--color-border); 
        text-align: center;
        width: 90%;
        max-width: 400px;
        transform: rotate(-3deg);
        box-sizing: border-box;
    }
    
    p {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 30px;
        line-height: 1.2;
    }
    
    .date-text {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 10px; 
        color: var(--color-text-dark); 
        transform: rotate(1deg);
    }
    
    /* ì‚¬ìš©ì ì •ë³´ í‘œì‹œ */
    #user-info-display {
        font-size: 1.4rem;
        color: var(--color-rose);
        margin-top: -10px;
        margin-bottom: 10px; /* XP Bar ê³µê°„ í™•ë³´ */
        background-color: #fff8e1;
        border-radius: 10px;
        padding: 8px;
        border: 2px solid var(--color-rose);
        transform: rotate(1deg);
    }

    /* XP Bar ìŠ¤íƒ€ì¼ */
    #xp-bar-container {
        width: 100%;
        height: 18px;
        background-color: #eee;
        border-radius: 9px;
        margin-bottom: 30px;
        overflow: hidden;
        border: 2px solid var(--color-border);
        box-shadow: 2px 2px 0 0 var(--color-border);
    }
    #xp-bar {
        height: 100%;
        width: 0%;
        background-color: #00b0ff;
        /* Duolingo Blue */
        transition: width 0.5s ease-out;
        position: relative;
    }
    #xp-text {
        position: absolute;
        width: 100%;
        text-align: center;
        line-height: 18px;
        font-size: 0.8rem;
        font-weight: bold;
        color: var(--color-text-dark);
        text-shadow: 1px 1px 0 #fff;
    }


    /* --- 3. ë²„íŠ¼ ë””ìì¸ --- */
    button {
        font-family: 'Jua', sans-serif;
        font-weight: bold;
        font-size: 1.2rem;
        padding: 12px 25px;
        margin: 8px;
        border-radius: 30px;
        border: 4px solid var(--color-border); 
        color: var(--color-border);
        cursor: pointer;
        box-shadow: 4px 4px 0px 0px var(--color-border);
        transform: rotate(2deg); 
        background-color: #fff;
        transition: all 0.1s; 
        width: 100%;
        /* ë©”ì¸ ë²„íŠ¼ ëª¨ë‘ 100% */
    }

    button:hover {
        transform: scale(1.02) rotate(2deg);
        box-shadow: 6px 6px 0px 0px var(--color-border);
    }

    button:active {
        transform: scale(0.97) rotate(1deg);
        box-shadow: 2px 2px 0px 0px var(--color-border); 
    }

    #lunch-menu { background-color: var(--color-rose); transform: rotate(-4deg);
    }
    #schedule-btn { background-color: var(--color-grass); transform: rotate(3deg); }
    #timetable-btn { background-color: var(--color-sky); transform: rotate(-1deg);
    }
    #minigame-btn { background-color: var(--color-apricot); transform: rotate(5deg);
    } 
    
    #yes_btn { background-color: var(--color-rose); transform: rotate(-4deg);
    }
    #no_btn { background-color: var(--color-grass); }
    #back_btn { background-color: var(--color-sky);
    }
    #settings-btn { 
        background-color: var(--color-apricot); 
        font-size:0.9rem; 
        padding: 10px 20px;
        margin-top: 15px; 
        width: auto;
    }
    
    #ranking-btn-group {
        display: flex;
        justify-content: space-between;
        margin-top: 15px;
    }
    #ranking-btn-group button {
        flex-grow: 1;
        width: 48%;
        margin: 0 4px;
        font-size: 1rem;
        padding: 10px 15px;
        box-shadow: 3px 3px 0px 0px var(--color-border);
        transform: rotate(0deg) !important;
    }
    #ranking-btn-group .active {
        background-color: gold !important;
        border-color: darkgoldenrod !important;
        box-shadow: 1px 1px 0 0 var(--color-border);
    }

    #clear-ranking-btn {
        background-color: #fce8e8 !important;
        color: #cc0000 !important; 
        border-color: #cc0000 !important; 
        margin-top: 20px;
    }

    /* --- 4. ë©”ì‹œì§€ ë° í‘œ ì˜ì—­ --- */
    .hidden { display: none !important;
    }
    .message {
        font-size: 1.6rem;
        font-weight: bold;
        margin-top: 20px;
        color: var(--color-text-dark);
        margin-bottom: 20px;
    }

    /* --- 5. ë¯¸ë‹ˆ ê²Œì„ ìŠ¤íƒ€ì¼ --- */
    #minigame-screen {
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    #game-area {
        width: 100%;
        height: 150px; background-color: #f6f0e9;
        border: 3px solid var(--color-border); border-radius: 15px;
        margin-bottom: 20px; position: relative; overflow: hidden;
    }
    #thief {
        position: absolute; top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        font-size: 3rem; cursor: pointer; transition: transform 0.1s, opacity 0.3s; 
        opacity: 0; background-color: var(--color-rose); border-radius: 50%;
        padding: 5px 15px; border: 2px dashed var(--color-border); line-height: 1; user-select: none; 
    }
    #game-status { font-size: 1.5rem;
        margin-bottom: 15px; color: var(--color-text-dark); }
    #game-score { font-size: 2rem; color: var(--color-rose); font-weight: bold;
    }
    .start-game-btn { background-color: var(--color-sky) !important; width: auto !important;
    }

    /* --- 6. í‘œ (Table) ë””ìì¸ --- */
    #menu_table_area, #ranking-table-area {
        margin-top: 20px;
        padding: 10px; border: 2px dashed var(--color-sky);
        border-radius: 15px; background-color: #fffbf5; width: 100%;
        box-sizing: border-box; max-height: 400px; overflow-y: auto;
    }
    #ranking-table, #menu_table {
        width: 100%; border-collapse: collapse; font-size: 1rem;
    }
    #ranking-table th, #ranking-table td, #menu_table th, #menu_table td {
        border: 1px solid var(--color-border);
        padding: 8px 5px; text-align: center;
    }
    #ranking-table th, #menu_table th {
        background-color: var(--color-sky);
        color: var(--color-border);
        font-size: 1.1rem; position: sticky; top: 0; z-index: 10;
    }
    #ranking-table tbody tr:nth-child(1) { background-color: #FFD700;
        font-weight: bold; }
    #ranking-table tbody tr:nth-child(2) { background-color: #C0C0C0;
    }
    #ranking-table tbody tr:nth-child(3) { background-color: #CD7F32;
    }
    
    /* ê¹€ëŒ€ì› ë¬¸êµ¬ ìˆ¨ê¹€ */
    #creator-info { display: none !important;
    }
</style>
</head>
<body>
<div id="question" class="card">
    <p>í•´ëˆ„ë¦¬ ì´ˆë“±í•™êµ í•™ìƒì…ë‹ˆê¹Œ? ğŸ</p>
    <button id="yes_btn">ë„¤! ë§ìŠµë‹ˆë‹¤! ğŸ¥³</button>
    <button id="no_btn">ì•„ë‹™ë‹ˆë‹¤ ğŸ˜¥</button>
</div>

<div id="portal" class="card hidden">
    <p id="today-date-display" class="date-text"></p> 
    <p id="user-info-display">í™˜ì˜í•©ë‹ˆë‹¤!</p>
    
    <div id="xp-bar-container">
        <div id="xp-bar"></div>
        <div id="xp-text"></div>
    </div>
    <p>ìš°ë¦¬ í•™êµ ì •ë³´ë¥¼ í™•ì¸í•©ë‹ˆë‹¤. ğŸ«</p>
    
    <button id="lunch-menu">ê¸‰ì‹ ë©”ë‰´ ğŸš</button>
    <button id="schedule-btn">í•™ì‚¬ ì¼ì • í™•ì¸ ğŸ—“ï¸</button>
    <button id="timetable-btn">ì˜¤ëŠ˜ ì‹œê°„í‘œ â°</button>
    <button id="minigame-btn">ë¯¸ë‹ˆ ê²Œì„! ğŸ•¹ï¸</button>
    
    <button id="settings-btn">í•™ë…„/ë°˜/ì´ë¦„ ì„¤ì • âš™ï¸</button> 
</div>

<div id="message_area" class="card hidden">
    <p id="message_text" class="message hidden"></p> 
    
    <div id="dateNavigation" style="margin-bottom: 10px; width: 100%;">
        <div id="dayNavButtons" class="hidden" style="display: flex; justify-content: space-around;">
            <button id="prev_day" style="background-color: var(--color-grass); font-size: 1rem; padding: 8px 15px; flex-grow: 1; margin: 5px;">â¬…ï¸ ì´ì „ ë‚ ì§œ</button>
            <button id="next_day" style="background-color: var(--color-sky); font-size: 1rem; padding: 8px 15px; flex-grow: 1; margin: 5px;">ë‹¤ìŒ ë‚ ì§œ â¡ï¸</button>
        </div>
        <div id="monthNavButtons" class="hidden" style="display: flex; justify-content: space-around;">
            <button id="prev_month" style="background-color: var(--color-rose); font-size: 1rem; padding: 8px 15px; flex-grow: 1; margin: 5px;">âª ì´ì „ ë‹¬</button>
            <button id="next_month" style="background-color: var(--color-apricot); font-size: 1rem; padding: 8px 15px; flex-grow: 1; margin: 5px;">ë‹¤ìŒ ë‹¬ â©</button>
        </div>
    </div>
    
    <div id="menu_table_area" class="hidden">
        <p id="no-waste-message" class="hidden" style="color: #FF5733; font-size: 1.5rem; transform: rotate(2deg); margin-bottom: 15px; background-color: #fff8e1; padding: 5px; border-radius: 10px; border: 2px solid #FF5733;">
            âœ¨ ì˜¤ëŠ˜ì€ ì”ë°˜ ì—†ëŠ” ë‚ ! ëª¨ë‘ ê¹¨ë—ì´ ë¨¹ì–´ìš”! âœ¨
        </p>
        
        <h3>ì •ë³´ ì œëª©</h3>
        <table id="menu_table"></table>
    </div>

    <button id="back_btn">ì´ì „ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
</div>

<div id="minigame-screen" class="card hidden"> 
    <p>ğŸ•¹ï¸ ê¸‰ì‹ ë„ë‘‘ ì¡ì•„ë¼!</p>
    <div id="game-status">ë„ì „!</div>
    
    <div id="game-area">
        <span id="thief">ğŸš</span>
    </div>

    <button id="start-game-btn" class="start-game-btn" onclick="game.start()">ê²Œì„ ì‹œì‘!</button>
    <p id="game-score">ì ìˆ˜: 0ì </p>
    
    <button id="show-ranking-btn" onclick="StateManager.showRanking('minigame')">ğŸ† ì „ì²´ ë­í‚¹ ë³´ê¸°</button> 
    <button id="minigame-back-btn" onclick="StateManager.showScreen('portal', 'access-state')">í¬í„¸ë¡œ ëŒì•„ê°€ê¸°</button>
</div>

<div id="ranking-screen" class="card hidden">
    <p>ğŸ¥‡ í•´ëˆ„ë¦¬ ì´ˆ ë­í‚¹</p>
    
    <div id="ranking-btn-group">
        <button id="minigame-ranking-btn" onclick="StateManager.showRanking('minigame')">ë¯¸ë‹ˆê²Œì„ ìµœê³  ê¸°ë¡</button>
        <button id="xp-ranking-btn" onclick="StateManager.showRanking('xp')">ëˆ„ì  XP ë­í‚¹</button>
    </div>
    <div id="ranking-table-area">
        <h3 id="ranking-title-text" style="color: var(--color-rose); margin-bottom: 10px;">ë¯¸ë‹ˆê²Œì„ ìµœê³  ê¸°ë¡</h3>
        <table id="ranking-table">
            <thead>
                <tr>
                    <th>ìˆœìœ„</th>
                    <th>í•™ë…„/ë°˜</th>
                    <th>ì´ë¦„</th>
                    <th>ì ìˆ˜/XP</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>
    
    <button 
        id="clear-ranking-btn" 
        class="hidden" 
        style="background-color: #fce8e8; color: #cc0000; border-color: #cc0000; margin-top: 20px;"
        onclick="clearRankingAndReload()">
        â›” ë­í‚¹ ê¸°ë¡ ì „ì²´ ì´ˆê¸°í™” (ê´€ë¦¬ì ì „ìš©)
    </button>
    <button id="ranking-back-btn" onclick="StateManager.showScreen('portal', 'access-state')">í¬í„¸ë¡œ ëŒì•„ê°€ê¸°</button>
</div>


<p id="creator-info">Made by ê¹€ëŒ€ì›</p>

<script>
// ----------------------------------------------------
// âœ¨ 1. ì„¤ì • ë° ë³€ìˆ˜ âœ¨
// ----------------------------------------------------

let currentDisplayDate = new Date();
let currentScreenMode = 'portal'; 

const NEIS_CONFIG = {
    KEY: "59ff63a46d7f41bf97464e3caf3a486c", 
    ATPT_OFCDC_SC_CODE: "B10", 
    SD_SCHUL_CODE: "7130255",  
    TIME_TABLE_URL: "https://open.neis.go.kr/hub/elsTimetable",
    MEAL_URL: "https://open.neis.go.kr/hub/mealServiceDietInfo",
    SCHEDULE_URL: "https://open.neis.go.kr/hub/SchoolSchedule",
};

// ì‚¬ìš©ì ì„¤ì • ë° XP, ê´€ë¦¬ì ìƒíƒœë¥¼ ë¡œì»¬ ì €ì¥ì†Œì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
let userGrade = localStorage.getItem('user_grade') || '5'; 
let userClass = localStorage.getItem('user_class') || '5'; 
let userName = localStorage.getItem('user_name') || '';

// ë­í‚¹ ì €ì¥ì†Œ í‚¤
const RANKING_KEY_MINIGAME = "minigame_scores"; 
const RANKING_KEY_XP = "total_xp_ranking";
 // XP ë­í‚¹ í‚¤

// ğŸš¨ ê´€ë¦¬ì ì •ë³´ ì •ì˜ ë° ìƒíƒœ
const ADMIN_GRADE = '5';
const ADMIN_CLASS = '5';
 const ADMIN_NAME = 'ê¹€ëŒ€ì›';
const ADMIN_PASSWORD = 'eodnjs14';
let isAdmin = localStorage.getItem('is_admin') === 'true';
 // XP ê´€ë ¨ ì„¤ì •
const XP_LEVELS = [
    { threshold: 0, level: 1, title: 'ìƒˆì‹¹ í•´ëˆ„ë¦¬ ğŸŒ±', next: 100 },
    { threshold: 100, level: 2, title: 'ì •ë³´ íƒí—˜ê°€ ğŸ§­', next: 300 },
    { threshold: 300, level: 3, title: 'ê¸‰ì‹ ìˆ˜í˜¸ì ğŸ›¡ï¸', next: 600 },
    { threshold: 600, level: 4, title: 'í•™êµ ë§ˆìŠ¤í„° ğŸ“', next: 99999 },
];
 const XP_DAILY_KEY = 'xp_daily_log'; // ì˜¤ëŠ˜ XP íšë“ ë¡œê·¸ í‚¤

// ----------------------------------------------------
// âœ¨ 2. XP ë° ë ˆë²¨ ê´€ë¦¬ í•¨ìˆ˜ âœ¨
// ----------------------------------------------------

function getXPData() {
    const xpJson = localStorage.getItem(RANKING_KEY_XP);
 try {
        return xpJson ? JSON.parse(xpJson) : {};
 } catch (e) {
        console.error("Error parsing XP data:", e);
        return {};
 }
}

function getUserXP() {
    const xpData = getXPData();
    const userKey = `${userGrade}-${userClass}-${userName}`;
    return xpData[userKey] ? xpData[userKey].totalXP : 0;
 }

function getLevelInfo(xp) {
    let currentLevel = XP_LEVELS[0];
 for (const info of XP_LEVELS) {
        if (xp >= info.threshold) {
            currentLevel = info;
 } else {
            break;
 }
    }
    const nextLevel = XP_LEVELS.find(l => l.threshold > currentLevel.threshold) || currentLevel;
    const progress = (xp - currentLevel.threshold) / (nextLevel.threshold - currentLevel.threshold);
    return { 
        ...currentLevel, 
        nextThreshold: nextLevel.threshold, 
        progress: progress * 100 
    };
 }

function getDailyLog() {
    const today = new Date().toDateString();
    const logJson = localStorage.getItem(XP_DAILY_KEY);
    const log = logJson ?
 JSON.parse(logJson) : {};
    // ì˜¤ëŠ˜ ë¡œê·¸ê°€ ì•„ë‹ˆë©´ ì´ˆê¸°í™”
    if (log.date !== today) {
        return { date: today, meal: false, schedule: false, timetable: false };
 }
    return log;
}

function updateDailyLog(key) {
    const log = getDailyLog();
    log[key] = true;
 localStorage.setItem(XP_DAILY_KEY, JSON.stringify(log));
}


function earnXP(amount, reason) {
    if (!userName || !userGrade || !userClass) return;

    const userKey = `${userGrade}-${userClass}-${userName}`;
 const xpData = getXPData();
    
    // XP ë°ì´í„° êµ¬ì¡° ì´ˆê¸°í™”
    if (!xpData[userKey]) {
        xpData[userKey] = {
            totalXP: 0,
            grade: userGrade,
            class: userClass,
            name: userName
        };
 }

    xpData[userKey].totalXP += amount;
    
    // ë¡œì»¬ ì €ì¥ì†Œ ì—…ë°ì´íŠ¸
    localStorage.setItem(RANKING_KEY_XP, JSON.stringify(xpData));
    
    updateUserInfoDisplay();
 if (amount > 0) {
        console.log(`ğŸ‰ ${amount} XP íšë“! (${reason})`); // alert ëŒ€ì‹  console.log ì‚¬ìš©
 }
}

// ----------------------------------------------------
// âœ¨ 3. ì‚¬ìš©ì ì„¤ì • í•¨ìˆ˜ (ë¹„ë°€ë²ˆí˜¸ ì¸ì¦ ë¡œì§ í¬í•¨) âœ¨
// ----------------------------------------------------

function saveSettings(grade, classNum, name, verifiedAdmin = false) {
    localStorage.setItem('user_grade', grade);
 localStorage.setItem('user_class', classNum);
    localStorage.setItem('user_name', name);
    
    // ê´€ë¦¬ì ìƒíƒœ ì €ì¥
    isAdmin = verifiedAdmin;
    localStorage.setItem('is_admin', verifiedAdmin ? 'true' : 'false');
 userGrade = grade;
    userClass = classNum;
    userName = name;
    
    updateUserInfoDisplay();
 }

function promptForSettings() {
    const grade = prompt(`í˜„ì¬ í•™ë…„: ${userGrade || '?'}\nìƒˆ í•™ë…„ì„ ìˆ«ìë¡œ ì…ë ¥í•´ ì£¼ì„¸ìš” (ì˜ˆ: 5)`);
 if (grade === null || isNaN(grade) || !grade.trim()) return; 
    
    const classNum = prompt(`í˜„ì¬ ë°˜: ${userClass || '?'}\nìƒˆ ë°˜ì„ ìˆ«ìë¡œ ì…ë ¥í•´ ì£¼ì„¸ìš” (ì˜ˆ: 5)`);
 if (classNum === null || isNaN(classNum) || !classNum.trim()) return;

    const name = prompt(`í˜„ì¬ ì´ë¦„: ${userName || '?'}\nì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš” (ì˜ˆ: ê¹€OO)`);
 if (name === null || !name.trim()) return;

    const trimmedGrade = grade.trim();
    const trimmedClass = classNum.trim();
    const trimmedName = name.trim();
 let verifiedAdmin = false;

    // ğŸš¨ ê´€ë¦¬ì ê³„ì • ì²´í¬ ë° ë¹„ë°€ë²ˆí˜¸ í™•ì¸
    if (trimmedGrade === ADMIN_GRADE && trimmedClass === ADMIN_CLASS && trimmedName === ADMIN_NAME) {
        const password = prompt("ê¹€ëŒ€ì›ë‹˜, ê´€ë¦¬ì ê³„ì •ìœ¼ë¡œ ë“±ë¡í•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
 if (password === ADMIN_PASSWORD) {
            alert("âœ… ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
 verifiedAdmin = true;
        } else {
            alert("âŒ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤. ì¼ë°˜ ê³„ì •ìœ¼ë¡œ ë“±ë¡í•©ë‹ˆë‹¤.");
 verifiedAdmin = false;
        }
    }
    // ğŸš¨

    saveSettings(trimmedGrade, trimmedClass, trimmedName, verifiedAdmin);
 alert(`ì„¤ì • ì™„ë£Œ! ${trimmedGrade}í•™ë…„ ${trimmedClass}ë°˜ ${trimmedName}ë‹˜ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
}

function updateUserInfoDisplay() {
    const displayElement = document.getElementById('user-info-display');
    const totalXP = getUserXP();
 const levelInfo = getLevelInfo(totalXP);
    
    if (userName && userGrade && userClass) {
        let adminTag = isAdmin ?
 " [ğŸ‘‘ ê´€ë¦¬ì]" : "";
        displayElement.innerHTML = `
            ${userGrade}í•™ë…„ ${userClass}ë°˜ ${userName}ë‹˜${adminTag}<br>
            <span style="font-size: 1.1rem; color: #00b0ff;">${levelInfo.title} (Lv.${levelInfo.level})</span>
        `;
 // XP Bar ì—…ë°ì´íŠ¸
        const xpBar = document.getElementById('xp-bar');
        const xpText = document.getElementById('xp-text');
 xpBar.style.width = `${levelInfo.progress}%`;
        xpText.textContent = `XP: ${totalXP} / ${levelInfo.nextThreshold}`;

    } else {
        displayElement.textContent = "í™˜ì˜í•©ë‹ˆë‹¤! (ì„¤ì • í•„ìš”)";
 if (document.getElementById('xp-bar')) document.getElementById('xp-bar').style.width = '0%';
        if (document.getElementById('xp-text')) document.getElementById('xp-text').textContent = 'XP: 0';
 }
}

// ----------------------------------------------------
// âœ¨ 4. API í˜¸ì¶œ í•¨ìˆ˜ âœ¨
// ----------------------------------------------------

async function fetchMealDataFromAPI(dateObj) { 
    // ... (NEIS API í˜¸ì¶œ ë¡œì§ì€ ì´ì „ê³¼ ë™ì¼)
    const YYYYMMDD = `${dateObj.getFullYear()}${String(dateObj.getMonth() + 1).padStart(2, '0')}${String(dateObj.getDate()).padStart(2, '0')}`;
 const apiUrl = `${NEIS_CONFIG.MEAL_URL}?KEY=${NEIS_CONFIG.KEY}&Type=json&pIndex=1&pSize=100` +
                   `&ATPT_OFCDC_SC_CODE=${NEIS_CONFIG.ATPT_OFCDC_SC_CODE}` +
                   `&SD_SCHUL_CODE=${NEIS_CONFIG.SD_SCHUL_CODE}&MLSV_YMD=${YYYYMMDD}`;
 try {
        const response = await fetch(apiUrl);
        const data = await response.json();
 if (data.mealServiceDietInfo) {
            // XP íšë“ ë¡œì§
            const log = getDailyLog();
 if (new Date().toDateString() === dateObj.toDateString() && !log.meal) {
                earnXP(5, 'ì˜¤ëŠ˜ì˜ ê¸‰ì‹ ë©”ë‰´ í™•ì¸');
 updateDailyLog('meal');
            }
            // ... (ë©”ë‰´ íŒŒì‹± ë¡œì§)
            let menuString = data.mealServiceDietInfo[1].row[0].DDISH_NM;
 let menuArray = menuString
                .split('<br/>')
                .map(item => item.replace(/\([0-9\.]+\)/g, '').trim())
                .filter(item => item.length > 0);
 return { success: true, menu: menuArray };
        } else if (data.RESULT && data.RESULT.CODE === 'INFO-200') {
            return { error: `[ê³µì§€] ${dateObj.getMonth() + 1}ì›” ${dateObj.getDate()}ì¼ ê¸‰ì‹ ì •ë³´ëŠ” ì°¾ì„ ìˆ˜ ì—†ì–´ìš”.
 ğŸ¤”` };
        } else {
            return { error: `[ì—ëŸ¬] ê¸‰ì‹ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.` };
 }
    } catch (error) {
        return { error: `[ì—ëŸ¬] ê¸‰ì‹ API í†µì‹  ì˜¤ë¥˜: ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.` };
 }
}

async function fetchScheduleDataFromAPI(dateObj) { 
    // XP íšë“ ë¡œì§ (ì›”ê°„ ì¼ì • í™•ì¸)
    const log = getDailyLog();
 if (new Date().getMonth() === dateObj.getMonth() && !log.schedule) {
        earnXP(5, 'ì´ë²ˆ ë‹¬ í•™ì‚¬ ì¼ì • í™•ì¸');
 updateDailyLog('schedule');
    }
    // ... (NEIS API í˜¸ì¶œ ë¡œì§ì€ ì´ì „ê³¼ ë™ì¼)
    const startMonth = String(dateObj.getMonth() + 1).padStart(2, '0');
 const lastDayOfMonth = new Date(dateObj.getFullYear(), dateObj.getMonth() + 1, 0).getDate();
    const startDate = `${dateObj.getFullYear()}${startMonth}01`;
    const endDate = `${dateObj.getFullYear()}${startMonth}${lastDayOfMonth}`;
 const apiUrl = `${NEIS_CONFIG.SCHEDULE_URL}?KEY=${NEIS_CONFIG.KEY}&Type=json&pIndex=1&pSize=100` +
                   `&ATPT_OFCDC_SC_CODE=${NEIS_CONFIG.ATPT_OFCDC_SC_CODE}` +
                   `&SD_SCHUL_CODE=${NEIS_CONFIG.SD_SCHUL_CODE}` +
                   `&AA_FROM_YMD=${startDate}&AA_TO_YMD=${endDate}`;
 try {
        const response = await fetch(apiUrl);
        const data = await response.json();
 if (data.SchoolSchedule) {
            return { 
                success: true, 
                schedule: data.SchoolSchedule[1].row.map(item => ({ 
                    date: item.AA_YMD, 
                    content: item.EVENT_NM
   
              }))
            };
 } else if (data.RESULT && data.RESULT.CODE === 'INFO-200') {
            return { error: `[ê³µì§€] ${dateObj.getMonth() + 1}ì›” í•™ì‚¬ ì¼ì •ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”.
 ğŸ˜¥` };
        } else {
            return { error: `[ì—ëŸ¬] í•™ì‚¬ ì¼ì • ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.` };
 }
    } catch (error) {
        return { error: `[ì—ëŸ¬] í•™ì‚¬ ì¼ì • API í†µì‹  ì˜¤ë¥˜: ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.` };
 }
}


async function fetchTimeTableDataFromAPI(dateObj, grade, classNum) { 
    // XP íšë“ ë¡œì§
    const log = getDailyLog();
 if (new Date().toDateString() === dateObj.toDateString() && !log.timetable) {
        earnXP(5, 'ì˜¤ëŠ˜ ì‹œê°„í‘œ í™•ì¸');
        updateDailyLog('timetable');
 }

    // ... (NEIS API í˜¸ì¶œ ë¡œì§ì€ ì´ì „ê³¼ ë™ì¼)
    const YYYYMMDD = `${dateObj.getFullYear()}${String(dateObj.getMonth() + 1).padStart(2, '0')}${String(dateObj.getDate()).padStart(2, '0')}`;
    
    const apiUrl = `${NEIS_CONFIG.TIME_TABLE_URL}?KEY=${NEIS_CONFIG.KEY}&Type=json&pIndex=1&pSize=100` +
                   `&ATPT_OFCDC_SC_CODE=${NEIS_CONFIG.ATPT_OFCDC_SC_CODE}` +
                   `&SD_SCHUL_CODE=${NEIS_CONFIG.SD_SCHUL_CODE}` +
                   `&AY=${dateObj.getFullYear()}` + 
                   `&TI_FROM_YMD=${YYYYMMDD}&TI_TO_YMD=${YYYYMMDD}` + 
                   `&GRADE=${grade}&CLASS_NM=${classNum}`; 
                   
    try {
        const response = await fetch(apiUrl);
        const data = await response.json();

        if (data.elsTimetable) { 
            return { 
                success: true, 
                schedule: data.elsTimetable[1].row.map(item => ({ 
                    period: item.PERIO, 
                    subject: item.ITRT_CNTNT
                }))
            };
        } else if (data.RESULT && data.RESULT.CODE === 'INFO-200') {
            return { error: `INFO-200` }; 
        } else {
            return { error: `[ì—ëŸ¬] ì‹œê°„í‘œ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (NEIS í‚¤ ì˜¤ë¥˜)` };
        }
    } catch (error) {
        return { error: `[ì—ëŸ¬] ì‹œê°„í‘œ API í†µì‹  ì˜¤ë¥˜: ë„¤íŠ¸ì›Œí¬/CORS ë¬¸ì œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.` }; 
    }
}

// ----------------------------------------------------
// âœ¨ 5. ë°ì´í„° í‘œì‹œ í•¨ìˆ˜ (í…Œì´ë¸” ìƒì„± ë¡œì§) âœ¨
// ----------------------------------------------------

function displayMealAsTable(menuArray) {
    const tableBody = document.querySelector('#menu_table');
    tableBody.innerHTML = '';
    const headerRow = tableBody.insertRow();
    headerRow.innerHTML = '<th>No.</th><th>ë©”ë‰´</th>';
    menuArray.forEach((item, index) => {
        const row = tableBody.insertRow();
        const cellNo = row.insertCell();
        const cellMenu = row.insertCell();
        cellNo.textContent = index + 1;
        cellMenu.textContent = item;
    });
    document.querySelector('#menu_table_area h3').textContent = "ì˜¤ëŠ˜ì˜ ê¸‰ì‹ ë©”ë‰´";
}

function displayScheduleAsList(scheduleArray, year, month) {
    const tableBody = document.querySelector('#menu_table');
    tableBody.innerHTML = '';
    document.querySelector('#menu_table_area h3').textContent = `${year}ë…„ ${month}ì›” í•™ì‚¬ ì¼ì •`;
    const headerRow = tableBody.insertRow();
    headerRow.innerHTML = '<th>ë‚ ì§œ</th><th>ì¼ì • ë‚´ìš©</th>';
    scheduleArray.sort((a, b) => a.date.localeCompare(b.date));
    scheduleArray.forEach(item => {
        const row = tableBody.insertRow();
        const cellDate = row.insertCell();
        const cellContent = row.insertCell();
        const formattedDate = `${item.date.substring(4, 6)}/${item.date.substring(6, 8)}`;
        cellDate.textContent = formattedDate;
        cellDate.style.width = '30%';
        cellDate.style.color = 'var(--color-rose)';
        cellDate.style.fontWeight = 'bold';
        cellContent.textContent = item.content;
    });
}

function displayTimeTable(timeTableArray, grade, classNum) {
    const tableBody = document.querySelector('#menu_table');
    tableBody.innerHTML = '';
    document.querySelector('#menu_table_area h3').textContent = `${grade}í•™ë…„ ${classNum}ë°˜ ì˜¤ëŠ˜ ì‹œê°„í‘œ`;
    const headerRow = tableBody.insertRow(0);
    headerRow.innerHTML = '<th>êµì‹œ</th><th>ê³¼ëª©</th>';
    timeTableArray.forEach(item => {
        const row = tableBody.insertRow();
        const cellPeriod = row.insertCell();
        const cellSubject = row.insertCell();
        cellPeriod.innerHTML = `<span style="font-size:1.1rem; color: var(--color-rose); font-weight:bold;">${item.period}êµì‹œ</span>`;
        cellSubject.textContent = item.subject;
        cellSubject.style.textAlign = 'center';
    });
}

function displayTodayDate() {
    const today = currentDisplayDate;
    const year = today.getFullYear();
    const month = today.getMonth() + 1;
    const date = today.getDate();
    const day = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][today.getDay()];
    const todayActual = new Date();
    const isToday = todayActual.toDateString() === today.toDateString();
    let datePrefix = "ì˜¤ëŠ˜ì˜";
    let formattedDate = '';
    
    if (currentScreenMode === 'meal' || currentScreenMode === 'timetable') {
        datePrefix = isToday ? "ì˜¤ëŠ˜ì˜" : `${month}ì›” ${date}ì¼ì˜`;
        let subjectText = currentScreenMode === 'timetable' ? `${userGrade || '?'}í•™ë…„ ${userClass || '?'}ë°˜ì˜ ` : '';
        formattedDate = `${datePrefix} ${subjectText}`;
    } else if (currentScreenMode === 'schedule') {
        formattedDate = `${month}ì›”ì˜ í•™ì‚¬ì¼ì •`;
    }
    
    document.getElementById('today-date-display').textContent = `${formattedDate} (${day}ìš”ì¼)`;
}

// ----------------------------------------------------
// âœ¨ 6. ë­í‚¹ ê´€ë¦¬ í•¨ìˆ˜ (ìµœê³  ê¸°ë¡ë§Œ ì €ì¥í•˜ë„ë¡ ìˆ˜ì •ë¨) âœ¨
// ----------------------------------------------------

// ë¯¸ë‹ˆê²Œì„ ì ìˆ˜ ê°€ì ¸ì˜¤ê¸° (ê° ìœ ì €ì˜ ìµœê³  ê¸°ë¡ ë§µì„ ë°˜í™˜)
function getMinigameScores() {
    const scoresJson = localStorage.getItem(RANKING_KEY_MINIGAME);
    try {
        // ë°°ì—´ ëŒ€ì‹  ìœ ì € í‚¤-ìµœê³  ì ìˆ˜ ê°ì²´ (map) êµ¬ì¡°ë¥¼ ì‚¬ìš©
        return scoresJson ? JSON.parse(scoresJson) : {}; 
    } catch (e) {
        console.error("Error parsing minigame scores from localStorage:", e);
        return {};
    }
}

// ë¯¸ë‹ˆê²Œì„ ì ìˆ˜ ì €ì¥ (XP ëˆ„ì  í¬í•¨)
function saveScore(score) {
    if (!userName || !userGrade || !userClass) {
        alert("âš ï¸ ì ìˆ˜ë¥¼ ì €ì¥í•˜ë ¤ë©´ ë¨¼ì € 'í•™ë…„/ë°˜/ì´ë¦„ ì„¤ì •'ì„ ì™„ë£Œí•´ì•¼ í•©ë‹ˆë‹¤.");
        return;
    }
    
    if (score <= 0) { // 0ì  ì´í•˜ ê¸°ë¡ì€ ë­í‚¹ì— ë“±ë¡í•˜ì§€ ì•ŠìŒ
        earnXP(score, `ë¯¸ë‹ˆê²Œì„ ${score}ì  ë‹¬ì„±`);
        alert("ğŸ˜­ ì•„ì‰½ì§€ë§Œ, 0ì ì€ ë­í‚¹ì— ë“±ë¡ë˜ì§€ ì•Šì•„ìš”.");
        return;
    }

    const userKey = `${userGrade}-${userClass}-${userName}`;
    const bestScoresMap = getMinigameScores();
    const existingEntry = bestScoresMap[userKey];
    let isNewBestScore = false;

    // 1. ë¯¸ë‹ˆê²Œì„ ë­í‚¹ ì €ì¥: ìƒˆë¡œìš´ ì ìˆ˜ê°€ í˜„ì¬ ì €ì¥ëœ ìµœê³  ì ìˆ˜ë³´ë‹¤ ë†’ê±°ë‚˜, ê¸°ë¡ì´ ì—†ì„ ê²½ìš°ì—ë§Œ ì—…ë°ì´íŠ¸
    if (!existingEntry || score > existingEntry.score) {
        bestScoresMap[userKey] = {
            score: score,
            grade: userGrade,
            class: userClass,
            name: userName,
            timestamp: Date.now() 
        };
        isNewBestScore = true;
        // ë¡œì»¬ ì €ì¥ì†Œ ì—…ë°ì´íŠ¸
        localStorage.setItem(RANKING_KEY_MINIGAME, JSON.stringify(bestScoresMap));
    }
    
    // 2. XP ëˆ„ì  (ê²Œì„ì„ í”Œë ˆì´í–ˆìœ¼ë¯€ë¡œ XPëŠ” ì œê³µ)
    earnXP(score, `ë¯¸ë‹ˆê²Œì„ ${score}ì  ë‹¬ì„±`);
    
    // 3. ì•Œë¦¼ í‘œì‹œ
    if (isNewBestScore) {
        alert(`ğŸ‰ ìµœê³  ì ìˆ˜ ê¸°ë¡ ê°±ì‹ ! ${score}ì ì„ ë­í‚¹ì— ë“±ë¡í–ˆìŠµë‹ˆë‹¤.`);
    } else {
        alert(`ğŸ¤” ${score}ì  ê¸°ë¡! (í˜„ì¬ ìµœê³  ê¸°ë¡: ${existingEntry.score}ì . ê°±ì‹  ì‹¤íŒ¨!)`);
    }
}

// ğŸš¨ ë­í‚¹ ì´ˆê¸°í™” í•¨ìˆ˜ (ê´€ë¦¬ì ì „ìš© ë²„íŠ¼ì— ì—°ê²°)
function clearRankingAndReload() {
    if (!isAdmin) {
        alert("ì´ ê¸°ëŠ¥ì€ ê´€ë¦¬ìë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        return;
    }
    if (confirm("ğŸš¨ ê²½ê³ : ì •ë§ë¡œ ë¯¸ë‹ˆê²Œì„ ë­í‚¹, ëˆ„ì  XP ë­í‚¹, ì¼ì¼ XP ë¡œê·¸ë¥¼ ëª¨ë‘ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (XP ëˆ„ì  ë°ì´í„°ë„ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤)")) {
        localStorage.removeItem(RANKING_KEY_MINIGAME);
        localStorage.removeItem(RANKING_KEY_XP);
        localStorage.removeItem(XP_DAILY_KEY);
        alert("ë­í‚¹ ë° XP ê¸°ë¡ì´ ëª¨ë‘ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        // XP ì‹œìŠ¤í…œ ì´ˆê¸°í™” í›„ í™”ë©´ ìƒˆë¡œê³ ì¹¨
        updateUserInfoDisplay();
        StateManager.showRanking('minigame');
    }
}

// ----------------------------------------------------
// âœ¨ 7. ë¯¸ë‹ˆ ê²Œì„ ë¡œì§ âœ¨
// ----------------------------------------------------
const gameThiefElement = document.getElementById('thief');
const gameAreaElement = document.getElementById('game-area');
const gameStatusElement = document.getElementById('game-status');
const gameScoreElement = document.getElementById('game-score');
const gameStartBtnElement = document.getElementById('start-game-btn');
const game = {
    score: 0,
    timer: 0,
    gameInterval: null,
    moveInterval: null,
    timeLimit: 15,
    thiefElement: gameThiefElement,
    gameAreaElement: gameAreaElement,
    statusElement: gameStatusElement,
    scoreElement: gameScoreElement,
    startBtnElement: gameStartBtnElement,
    hitHandler: null,

    start: function() {
        if (this.gameInterval) this.stop();
        if (this.moveInterval) clearInterval(this.moveInterval);
        this.score = 0;
        this.timer = this.timeLimit;
        if (this.scoreElement) this.scoreElement.textContent = `ì ìˆ˜: 0ì `;
        if (this.startBtnElement) this.startBtnElement.classList.add('hidden');
        if (this.thiefElement) {
            this.thiefElement.style.opacity = 0;
            this.thiefElement.style.pointerEvents = 'none';
        }
        if (this.statusElement) this.statusElement.textContent = `ê²Œì„ ì‹œì‘! ${this.timer}ì´ˆ ë‚¨ì•˜ìŠµë‹ˆë‹¤!`;
        
        this.hitHandler = this.hit.bind(this);
        if (this.thiefElement) {
            this.thiefElement.removeEventListener('click', this.hitHandler);
            this.thiefElement.addEventListener('click', this.hitHandler);
        }

        setTimeout(() => {
            this.gameInterval = setInterval(this.update.bind(this), 1000);
            this.moveInterval = setInterval(this.moveThief.bind(this), 800);
            if (this.thiefElement) {
                this.thiefElement.style.opacity = 1;
                this.thiefElement.style.pointerEvents = 'auto';
            }
        }, 1000); // 1ì´ˆ í›„ ê²Œì„ ì‹œì‘
    },

    stop: function() {
        if (this.gameInterval) clearInterval(this.gameInterval);
        if (this.moveInterval) clearInterval(this.moveInterval);
        this.gameInterval = null;
        this.moveInterval = null;
        if (this.statusElement) this.statusElement.textContent = `ê²Œì„ ì¢…ë£Œ! ìµœì¢… ì ìˆ˜: ${this.score}ì `;
        if (this.thiefElement) {
            this.thiefElement.style.opacity = 0;
            this.thiefElement.style.pointerEvents = 'none';
        }
        if (this.startBtnElement) this.startBtnElement.classList.remove('hidden');

        // ì ìˆ˜ ì €ì¥ ë¡œì§ (XP ëˆ„ì  í¬í•¨)
        saveScore(this.score);
    },

    update: function() {
        if (this.timer <= 0) {
            this.stop();
            return;
        }
        this.timer--;
        if (this.statusElement) this.statusElement.textContent = `${this.timer}ì´ˆ ë‚¨ì•˜ìŠµë‹ˆë‹¤!`;
    },

    moveThief: function() {
        if (!this.gameAreaElement || !this.thiefElement) return;
        const areaWidth = this.gameAreaElement.clientWidth;
        const areaHeight = this.gameAreaElement.clientHeight;
        const thiefSize = 50;
        const randomX = Math.random() * (areaWidth - thiefSize);
        const randomY = Math.random() * (areaHeight - thiefSize);
        this.thiefElement.style.left = `${randomX}px`;
        this.thiefElement.style.top = `${randomY}px`;
    },

    hit: function() {
        this.score++;
        if (this.scoreElement) this.scoreElement.textContent = `ì ìˆ˜: ${this.score}ì `;
        this.moveThief();
        if (this.thiefElement) {
            this.thiefElement.style.transform = 'translate(-50%, -50%) scale(1.2)';
            setTimeout(() => {
                this.thiefElement.style.transform = 'translate(-50%, -50%) scale(1)';
            }, 100);
        }
    }
};

// ----------------------------------------------------
// âœ¨ 8. UI ë° ìƒíƒœ ê´€ë¦¬ (ë­í‚¹ í…Œì´ë¸” í‘œì‹œ ë¡œì§ ìˆ˜ì •ë¨) âœ¨
// ----------------------------------------------------
const UI = {
    screens: {
        question: document.getElementById("question"),
        portal: document.getElementById("portal"),
        message_area: document.getElementById("message_area"),
        "minigame-screen": document.getElementById("minigame-screen"),
        "ranking-screen": document.getElementById("ranking-screen"),
    },
    elements: {
        // ... (ì´ì „ ìš”ì†Œë“¤)
        body: document.body,
        message_text: document.getElementById("message_text"),
        back_btn: document.getElementById("back_btn"),
        yes_btn: document.getElementById("yes_btn"),
        no_btn: document.getElementById("no_btn"),
        lunch_menu_btn: document.getElementById("lunch-menu"),
        schedule_btn: document.getElementById("schedule-btn"),
        timetable_btn: document.getElementById("timetable-btn"),
        minigame_btn: document.getElementById("minigame-btn"),
        settings_btn: document.getElementById("settings-btn"),
        menu_table_area: document.getElementById("menu_table_area"),
        day_nav_buttons: document.getElementById("dayNavButtons"),
        month_nav_buttons: document.getElementById("monthNavButtons"),
        prev_btn: document.getElementById("prev_day"),
        next_btn: document.getElementById("next_day"),
        prev_month_btn: document.getElementById("prev_month"),
        next_month_btn: document.getElementById("next_month"),
        no_waste_msg: document.getElementById("no-waste-message"),
        ranking_table_body: document.querySelector('#ranking-table tbody'),
        clear_ranking_btn: document.getElementById('clear-ranking-btn'),
        ranking_title_text: document.getElementById('ranking-title-text'),
        minigame_ranking_btn: document.getElementById('minigame-ranking-btn'),
        xp_ranking_btn: document.getElementById('xp-ranking-btn'),
    }
};

const StateManager = {
    resetNavButtons: function() {
        if (UI.elements.day_nav_buttons) UI.elements.day_nav_buttons.classList.add("hidden");
        if (UI.elements.month_nav_buttons) UI.elements.month_nav_buttons.classList.add("hidden");
        if (UI.elements.no_waste_msg) UI.elements.no_waste_msg.classList.add("hidden");
        if (UI.elements.menu_table_area) UI.elements.menu_table_area.classList.add("hidden");
        if (UI.elements.message_text) UI.elements.message_text.classList.add("hidden");
    },

    showScreen: function(screenId, stateClass = '') {
        // ëª¨ë“  í™”ë©´ ìˆ¨ê¸°ê¸°
        Object.values(UI.screens).forEach(screen => {
            if (screen) {
                screen.classList.add("hidden");
                // ì´ì „ stateClass ì œê±° (íšŒì „ íš¨ê³¼ ì¬ì ìš© ë°©ì§€)
                screen.classList.remove('deny-state', 'access-state'); 
            }
        });
        
        // ìš”ì²­ëœ í™”ë©´ í‘œì‹œ
        const targetScreen = UI.screens[screenId];
        if (targetScreen) {
            targetScreen.classList.remove("hidden");
            targetScreen.classList.add(stateClass);
        }
        
        // í¬í„¸ í™”ë©´ ì§„ì… ì‹œ ë‚ ì§œ ë° XP í‘œì‹œ ì—…ë°ì´íŠ¸
        if (screenId === 'portal') {
            displayTodayDate();
            updateUserInfoDisplay(); 
        }

        // ë¯¸ë‹ˆê²Œì„ í™”ë©´ ì „í™˜ ì‹œ ê²Œì„ ì •ì§€
        if (screenId !== 'minigame-screen' && game.gameInterval) {
            game.stop();
        }

        // ë¯¸ë‹ˆê²Œì„ ë„ë‘‘ ìˆ¨ê¸°ê¸°
        if (screenId !== 'minigame-screen') {
            if (game.thiefElement) game.thiefElement.style.opacity = 0;
        }
    },

    // ë­í‚¹ í™”ë©´ í‘œì‹œ ë° ë°ì´í„° ë¡œë”© í•¨ìˆ˜ (typeì— ë”°ë¼ ë¶„ê¸°)
    showRanking: function(type = 'minigame') {
        this.showScreen("ranking-screen", 'access-state');
        // ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
        UI.elements.minigame_ranking_btn.classList.remove('active');
        UI.elements.xp_ranking_btn.classList.remove('active');
        if (type === 'xp') {
            UI.elements.xp_ranking_btn.classList.add('active');
            this.displayRankingTable(type);
        } else {
            UI.elements.minigame_ranking_btn.classList.add('active');
            this.displayRankingTable('minigame');
        }

        // ğŸš¨ ê´€ë¦¬ì ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€ ë¡œì§
        const clearBtn = UI.elements.clear_ranking_btn;
        if (clearBtn) {
            if (isAdmin) {
                clearBtn.classList.remove('hidden');
            } else {
                clearBtn.classList.add('hidden');
            }
        }
    },

    displayRankingTable: function(type) {
        const tableBody = UI.elements.ranking_table_body;
        if (!tableBody) return;
        tableBody.innerHTML = '';
        
        let dataArray = [];
        let scoreLabel = '';
        let titleText = '';
        let emptyMessage = '';

        if (type === 'xp') {
            const xpData = getXPData();
            dataArray = Object.values(xpData).sort((a, b) => b.totalXP - a.totalXP);
            scoreLabel = 'XP';
            titleText = 'ğŸ† ëˆ„ì  XP ë­í‚¹';
            emptyMessage = "ì•„ì§ XP ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ê¸‰ì‹/ì‹œê°„í‘œë¥¼ í™•ì¸í•˜ê±°ë‚˜ ë¯¸ë‹ˆê²Œì„ì— ë„ì „í•˜ì„¸ìš”! ğŸ’ª";
        } else { // minigame
            // --- ìˆ˜ì •ëœ ë¶€ë¶„: ë§µì„ ë°°ì—´ë¡œ ë³€í™˜í•˜ê³  ì ìˆ˜ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬ ---
            const bestScoresMap = getMinigameScores(); // ìœ ì €ë³„ ìµœê³  ê¸°ë¡ ë§µ ê°€ì ¸ì˜¤ê¸°
            dataArray = Object.values(bestScoresMap); // ë§µì˜ ê°’(ê¸°ë¡)ë“¤ì„ ë°°ì—´ë¡œ ë³€í™˜
            
            // ì ìˆ˜(score) ê¸°ì¤€ìœ¼ë¡œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
            dataArray.sort((a, b) => b.score - a.score); 

            scoreLabel = 'ì ìˆ˜';
            titleText = 'ğŸ•¹ï¸ ë¯¸ë‹ˆê²Œì„ ìµœê³  ê¸°ë¡';
            emptyMessage = "ì•„ì§ ë¯¸ë‹ˆê²Œì„ ìµœê³  ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ê²Œì„ì„ í”Œë ˆì´í•˜ê³  ë­í‚¹ì„ ë“±ë¡í•˜ì„¸ìš”! ğŸ•¹ï¸";
            // ----------------------------------------------------
        }

        UI.elements.ranking_title_text.textContent = titleText;

        if (dataArray.length === 0) {
            const row = tableBody.insertRow();
            const cell = row.insertCell();
            cell.colSpan = 4;
            cell.textContent = emptyMessage;
            cell.style.padding = '20px';
            return;
        }

        // í…Œì´ë¸” ìƒì„±
        dataArray.forEach((item, index) => {
            const row = tableBody.insertRow();
            const rank = index + 1;
            const rankCell = row.insertCell();
            const classCell = row.insertCell();
            const nameCell = row.insertCell();
            const scoreCell = row.insertCell();

            rankCell.textContent = rank;
            classCell.textContent = `${item.grade}í•™ë…„ ${item.class}ë°˜`;
            nameCell.textContent = item.name;
            scoreCell.textContent = item.score || item.totalXP;
            scoreCell.style.fontWeight = 'bold';
            scoreCell.style.color = 'var(--color-rose)';

            // í—¤ë” ì—…ë°ì´íŠ¸ (Score/XP ë ˆì´ë¸”)
            const scoreHeader = document.querySelector('#ranking-table thead tr th:last-child');
            if (scoreHeader) scoreHeader.textContent = scoreLabel;
        });
    },

    showMealMenu: async function(prevId) {
        this.resetNavButtons();
        currentScreenMode = 'meal';
        currentDisplayDate = new Date(); // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì´ˆê¸°í™”
        this.showScreen("message_area", 'access-state');
        UI.elements.day_nav_buttons.classList.remove("hidden");
        UI.elements.menu_table_area.classList.remove("hidden");
        
        await this.loadDataAndDisplay(prevId);
    },

    showSchedule: async function(prevId = 'portal') {
        this.resetNavButtons();
        currentScreenMode = 'schedule';
        currentDisplayDate = new Date(); // í˜„ì¬ ì›”ë¡œ ì´ˆê¸°í™”
        this.showScreen("message_area", 'access-state');
        UI.elements.month_nav_buttons.classList.remove("hidden");
        UI.elements.menu_table_area.classList.remove("hidden");
        
        await this.loadDataAndDisplay(prevId);
    },
    
    showTimeTable: async function(prevId = 'portal') {
        this.resetNavButtons();
        currentScreenMode = 'timetable';
        currentDisplayDate = new Date(); // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì´ˆê¸°í™”
        
        if (!userName || !userGrade || !userClass) {
            this.showScreen("message_area", 'access-state');
            UI.elements.message_text.classList.remove("hidden");
            UI.elements.message_text.textContent = "âš ï¸ ì‹œê°„í‘œë¥¼ ë³´ë ¤ë©´ 'í•™ë…„/ë°˜/ì´ë¦„ ì„¤ì •'ì„ ë¨¼ì € ì™„ë£Œí•´ ì£¼ì„¸ìš”!";
            UI.elements.menu_table_area.classList.add("hidden");
            UI.elements.back_btn.onclick = () => this.showScreen('portal', 'access-state');
            return;
        }
        
        this.showScreen("message_area", 'access-state');
        UI.elements.day_nav_buttons.classList.remove("hidden");
        UI.elements.menu_table_area.classList.remove("hidden");
        
        await this.loadDataAndDisplay(prevId);
    },

    showMinigame: function() {
        this.showScreen("minigame-screen", 'access-state');
    },

    changeDateAndReload: async function(delta, type) {
        const prevId = 'portal'; // ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ ì‹œ ëŒì•„ê°ˆ í™”ë©´
        
        if (type === 'day') {
            currentDisplayDate.setDate(currentDisplayDate.getDate() + delta);
            if (currentScreenMode === 'meal') {
                await this.loadDataAndDisplay(prevId);
            } else if (currentScreenMode === 'timetable') {
                await this.loadDataAndDisplay(prevId);
            }
        } else if (type === 'month') {
            currentDisplayDate.setMonth(currentDisplayDate.getMonth() + delta);
            if (currentScreenMode === 'schedule') {
                await this.loadDataAndDisplay(prevId);
            }
        }
    },

    loadDataAndDisplay: async function(prevId) {
        displayTodayDate();
        UI.elements.menu_table_area.classList.remove("hidden");
        UI.elements.message_text.classList.add("hidden");
        document.querySelector('#menu_table').innerHTML = '<tr><td colspan="2">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘... â³</td></tr>';

        let result;
        if (currentScreenMode === 'meal') {
            result = await fetchMealDataFromAPI(currentDisplayDate);
        } else if (currentScreenMode === 'schedule') {
            result = await fetchScheduleDataFromAPI(currentDisplayDate);
        } else if (currentScreenMode === 'timetable') {
            result = await fetchTimeTableDataFromAPI(currentDisplayDate, userGrade, userClass);
            if (result.error === 'INFO-200') {
                result.error = `[ê³µì§€] ${userGrade}í•™ë…„ ${userClass}ë°˜ì˜ ì‹œê°„í‘œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”. ğŸ˜¥ (ì£¼ë§ ë˜ëŠ” ë°©í•™ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤)`;
            }
        }
        
        // ì”ë°˜ ì—†ëŠ” ë‚  ë©”ì‹œì§€ í‘œì‹œ ë¡œì§ (ì¼ìš”ì¼, ìˆ˜ìš”ì¼ì´ ì”ë°˜ ì—†ëŠ” ë‚ ì´ë¼ê³  ê°€ì •)
        const dayOfWeek = currentDisplayDate.getDay();
        const noWasteMsg = UI.elements.no_waste_msg;
        if (currentScreenMode === 'meal' && (dayOfWeek === 0 || dayOfWeek === 3)) { // 0:ì¼, 3:ìˆ˜
            noWasteMsg.classList.remove("hidden");
        } else if (noWasteMsg) {
            noWasteMsg.classList.add("hidden");
        }

        if (result.success) {
            if (currentScreenMode === 'meal') {
                displayMealAsTable(result.menu);
            } else if (currentScreenMode === 'schedule') {
                displayScheduleAsList(result.schedule, currentDisplayDate.getFullYear(), currentDisplayDate.getMonth() + 1);
            } else if (currentScreenMode === 'timetable') {
                displayTimeTable(result.schedule, userGrade, userClass);
            }
        } else {
            UI.elements.message_text.classList.remove("hidden");
            UI.elements.message_text.textContent = result.error;
            UI.elements.menu_table_area.classList.add("hidden");
        }

        // ëŒì•„ê°€ê¸° ë²„íŠ¼ ì„¤ì •
        UI.elements.back_btn.onclick = () => this.showScreen(prevId, 'access-state');
    },
    
    // 'ì•„ë‹™ë‹ˆë‹¤' ë²„íŠ¼ í´ë¦­ ì‹œ ë¡œì§
    showDenyMessage: function() {
        this.showScreen("message_area", "deny-state");
        UI.elements.menu_table_area.classList.add("hidden");
        UI.elements.message_text.classList.remove("hidden");
        UI.elements.message_text.textContent = "ì•„ì§ í•´ëˆ„ë¦¬ ì¹œêµ¬ê°€ ì•„ë‹ˆêµ°ìš”! ë‹¤ìŒì— ê¼­ ë§Œë‚˜ìš”! ğŸ‘‹";
        
        // ëŒì•„ê°€ê¸° ë²„íŠ¼ ì„¤ì • (ì§ˆë¬¸ í™”ë©´ìœ¼ë¡œ ë³µê·€)
        UI.elements.back_btn.onclick = () => this.showScreen("question", "deny-state");
    },
    
    initEventListeners: function() {
        // 1. ë„¤/ì•„ë‹ˆì˜¤ ë²„íŠ¼
        UI.elements.yes_btn.addEventListener("click", () => {
            this.showScreen("portal", "access-state");
        });
        UI.elements.no_btn.addEventListener("click", () => {
            this.showDenyMessage();
        });
        
        // 2. ë©”ì¸ ë²„íŠ¼
        if (UI.elements.lunch_menu_btn) UI.elements.lunch_menu_btn.addEventListener("click", () => {
            this.showMealMenu("portal", "access-state");
        });
        if (UI.elements.schedule_btn) UI.elements.schedule_btn.addEventListener("click", () => {
            this.showSchedule();
        });
        if (UI.elements.timetable_btn) UI.elements.timetable_btn.addEventListener("click", () => {
            this.showTimeTable();
        });
        if (UI.elements.minigame_btn) UI.elements.minigame_btn.addEventListener("click", () => {
            this.showMinigame();
        });
        
        if (UI.elements.settings_btn) UI.elements.settings_btn.addEventListener("click", () => {
            promptForSettings();
        });

        // 3. ë‚ ì§œ ì´ë™ ë²„íŠ¼
        if (UI.elements.prev_btn) UI.elements.prev_btn.addEventListener("click", () => {
            this.changeDateAndReload(-1, 'day'); 
        });
        if (UI.elements.next_btn) UI.elements.next_btn.addEventListener("click", () => {
            this.changeDateAndReload(1, 'day'); 
        });

        if (UI.elements.prev_month_btn) UI.elements.prev_month_btn.addEventListener("click", () => {
            this.changeDateAndReload(-1, 'month'); 
        });
        if (UI.elements.next_month_btn) UI.elements.next_month_btn.addEventListener("click", () => {
            this.changeDateAndReload(1, 'month');
        });
    },

    // ì´ˆê¸° ë¡œë”© ì‹œ í™”ë©´ ìƒíƒœ ê²°ì •
    initialLoad: function() {
        this.initEventListeners();
        updateUserInfoDisplay(); // XP ìƒíƒœ ì´ˆê¸° ë¡œë”©
        
        // ë¡œì»¬ ì €ì¥ì†Œì— ì‚¬ìš©ì ì •ë³´ê°€ ìˆìœ¼ë©´ ë°”ë¡œ í¬í„¸ë¡œ, ì—†ìœ¼ë©´ ì§ˆë¬¸ í™”ë©´ìœ¼ë¡œ
        if (localStorage.getItem('user_grade') && localStorage.getItem('user_name')) {
            this.showScreen('portal', 'access-state');
        } else {
            // ì´ì „ì— hiddenì„ ì œê±°í–ˆìœ¼ë¯€ë¡œ, ì—¬ê¸°ì„œ ë‹¤ì‹œ ì„¤ì •í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            // this.showScreen('question'); 
        }
    }
};

// ----------------------------------------------------
// âœ¨ 9. ì´ˆê¸°í™” ì‹¤í–‰ âœ¨
// ----------------------------------------------------

document.addEventListener('DOMContentLoaded', () => {
    StateManager.initialLoad();
});

</script>
</body>
</html>
