<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>í•´ëˆ„ë¦¬ ì´ˆë“±í•™êµ 5í•™ë…„ ìš°ë¦¬ë“¤ì˜ ê³µê°„ ğŸ«ğŸ„</title>
<link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
<style>
    :root {
        --color-apricot: #ffd9a8; --color-sky: #a8d5ff; --color-rose: #ffc9d4;
        --color-grass: #d2f6c9; --color-text-dark: #3a322b; 
        --color-card-bg: #ffffff; --color-border: #3a322b;
        --color-gold: #FFD700;
    }

    body {
        font-family: 'Jua', sans-serif;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        min-height: 100vh; margin: 0; background-color: var(--color-sky); color: var(--color-text-dark);
        background-image: 
            radial-gradient(circle at 50% 50%, white 2.5px, transparent 2.5px),
            radial-gradient(circle at 20% 80%, white 3.5px, transparent 3.5px);
        background-size: 150px 150px, 250px 250px;
        animation: snow-animation 12s linear infinite;
        overflow-x: hidden;
    }
    @keyframes snow-animation {
        0% { background-position: 0 0, 0 0; }
        100% { background-position: 60px 1000px, -60px 1000px; }
    }

    .card {
        background-color: var(--color-card-bg); border-radius: 35px; padding: 30px;
        border: 4px dashed var(--color-border); box-shadow: 6px 6px 0 0 var(--color-border);
        text-align: center; width: 92%; max-width: 400px; transform: rotate(-2deg);
        box-sizing: border-box; position: relative; margin: 15px;
    }
    
    #user-info-display {
        font-size: 1.2rem; background-color: #fff8e1; border-radius: 15px; padding: 10px;
        border: 2.5px solid var(--color-gold); margin-bottom: 10px;
    }
    .title-badge { display: inline-block; padding: 2px 10px; border-radius: 10px; background-color: #333; color: var(--color-gold); font-size: 0.85rem; margin-top: 5px; }

    #xp-bar-container {
        width: 100%; height: 18px; background-color: #eee; border-radius: 10px;
        margin-bottom: 20px; overflow: hidden; border: 2px solid var(--color-border); position: relative;
    }
    #xp-bar { height: 100%; width: 0%; background-color: var(--color-gold); transition: width 0.6s; }
    #xp-text { position: absolute; width: 100%; text-align: center; line-height: 18px; font-size: 0.8rem; font-weight: bold; }

    button {
        font-family: 'Jua', sans-serif; font-weight: bold; font-size: 1.1rem;
        padding: 12px; margin: 6px 0; border-radius: 30px; border: 4px solid var(--color-border);
        cursor: pointer; background-color: #fff; width: 100%; box-shadow: 4px 4px 0px 0px var(--color-border);
    }
    button:active { transform: scale(0.96); box-shadow: 2px 2px 0px 0px var(--color-border); }

    table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; }
    th, td { border: 1px solid var(--color-border); padding: 8px; text-align: center; font-size: 0.9rem; }
    th { background-color: var(--color-sky); }

    .hidden { display: none !important; }
    #thief { position: absolute; font-size: 3rem; cursor: pointer; display: none; user-select: none; }
</style>
</head>
<body>

<div id="question" class="card">
    <p>í•´ëˆ„ë¦¬ ì´ˆë“±í•™êµ í•™ìƒì…ë‹ˆê¹Œ? ğŸ</p>
    <button onclick="if(!userName) promptForSettings(); else StateManager.showScreen('portal')" style="background-color: var(--color-rose);">ë„¤! ë§ìŠµë‹ˆë‹¤! ğŸ¥³</button>
</div>

<div id="portal" class="card hidden">
    <div id="user-info-display"></div>
    <div id="xp-bar-container"><div id="xp-bar"></div><div id="xp-text"></div></div>
    
    <button onclick="StateManager.loadData('meal')" style="background-color: var(--color-rose);">ê¸‰ì‹ ë©”ë‰´ ğŸš</button>
    <button onclick="StateManager.loadData('timetable')" style="background-color: #cceeff;">ì˜¤ëŠ˜ ì‹œê°„í‘œ â°</button>
    <button onclick="StateManager.showScreen('roulette-screen')" style="background-color: var(--color-gold);">í–‰ìš´ì˜ ëŒë¦¼íŒ ğŸ¡</button>
    <button onclick="showTitleList()" style="background-color: #e1f5fe;">ë‚˜ì˜ ì¹­í˜¸ ëª©ë¡ ğŸ–ï¸</button>
    <button onclick="showRanking('xp')" style="background-color: #d2f6c9;">XP ë­í‚¹ ğŸ†</button>
    <button onclick="showRanking('game')" style="background-color: #ffccbc;">ë¯¸ë‹ˆê²Œì„ ë­í‚¹ ğŸ¥‡</button>
    <button onclick="StateManager.showScreen('minigame-screen')" style="background-color: var(--color-apricot);">ì„ ë¬¼ í›”ì¹˜ê¸° ê²Œì„ ğŸ®</button>
    
    <button id="inquiry-btn" class="hidden" onclick="StateManager.showScreen('inquiry-screen')" style="background-color: #e1bee7;">ìš´ì˜ì ë¬¸ì˜ âœ‰ï¸</button>
    <button onclick="promptForSettings()" style="font-size: 0.8rem; width: auto; margin-top: 15px;">ì •ë³´ ì„¤ì • âš™ï¸</button>
</div>

<div id="ranking-screen" class="card hidden">
    <p id="rank-title" style="font-size: 1.5rem;">ğŸ¥‡ ë­í‚¹</p>
    <div style="max-height: 250px; overflow-y: auto;">
        <table>
            <thead><tr><th>ìˆœìœ„</th><th>ì´ë¦„</th><th id="rank-col-name">ì ìˆ˜</th></tr></thead>
            <tbody id="ranking-body"></tbody>
        </table>
    </div>
    <button onclick="StateManager.showScreen('portal')" style="margin-top:10px;">ëŒì•„ê°€ê¸°</button>
</div>

<div id="minigame-screen" class="card hidden">
    <p style="font-size: 1.5rem;">ğŸ ì„ ë¬¼ í›”ì¹˜ê¸°</p>
    <div id="game-area" style="width:100%; height:150px; background:#e0f2ff; position:relative; overflow:hidden; border-radius:15px; border:2px solid #333;">
        <span id="thief">ğŸ…</span>
    </div>
    <p id="game-score">ì ìˆ˜: 0ì </p>
    <button id="start-btn" onclick="startThiefGame()">ê²Œì„ ì‹œì‘!</button>
    <button onclick="StateManager.showScreen('portal')">ê·¸ë§Œí•˜ê¸°</button>
</div>

<div id="roulette-screen" class="card hidden">... (ëŒë¦¼íŒ ì½”ë“œ ë™ì¼) ...</div>

<script>
// --- [ë°ì´í„° ì„¤ì •] ---
const ADMIN_CONF = { name: 'ê°•ë¯¼ì¤€', pw: 'minjun55' }; 
const OPERATOR_CONF = { name: 'ê¹€ëŒ€ì›', pw: 'eodnjs14' }; 

let userName = localStorage.getItem('user_name') || '';
let userGrade = localStorage.getItem('user_grade') || '';
let userClass = localStorage.getItem('user_class') || '';
let role = localStorage.getItem('user_role') || 'user';
let activeTitle = localStorage.getItem('active_title') || 'sprout';

// --- [ë­í‚¹ í†µí•© ë¡œì§] ---
function showRanking(type) {
    StateManager.showScreen('ranking-screen');
    const title = document.getElementById('rank-title');
    const colName = document.getElementById('rank-col-name');
    const body = document.getElementById('ranking-body');
    
    if(type === 'xp') {
        title.innerText = "ğŸ† ì „ì²´ XP ë­í‚¹";
        colName.innerText = "XP";
        const data = JSON.parse(localStorage.getItem('total_xp_ranking') || '{}');
        const sorted = Object.values(data).sort((a,b) => b.totalXP - a.totalXP);
        body.innerHTML = sorted.map((u, i) => `<tr><td>${i+1}</td><td>${u.name}</td><td>${u.totalXP}</td></tr>`).join('');
    } else {
        title.innerText = "ğŸ¥‡ ê²Œì„ ìµœê³ ì  ë­í‚¹";
        colName.innerText = "ì ìˆ˜";
        const data = JSON.parse(localStorage.getItem('game_ranking') || '{}');
        const sorted = Object.values(data).sort((a,b) => b.score - a.score);
        body.innerHTML = sorted.map((u, i) => `<tr><td>${i+1}</td><td>${u.name}</td><td>${u.score}</td></tr>`).join('');
    }
}

// --- [ê²Œì„ ê¸°ë¡ ì €ì¥ ë¡œì§] ---
function saveGameScore(score) {
    const k = `${userGrade}-${userClass}-${userName}`;
    const data = JSON.parse(localStorage.getItem('game_ranking') || '{}');
    if(!data[k] || data[k].score < score) {
        data[k] = { name: userName, score: score };
        localStorage.setItem('game_ranking', JSON.stringify(data));
    }
}

function startThiefGame() {
    let s = 0; const t = document.getElementById('thief'); t.style.display = 'block';
    const btn = document.getElementById('start-btn'); btn.disabled = true;
    let timer = setInterval(() => { t.style.top = Math.random()*70+'%'; t.style.left = Math.random()*80+'%'; }, 700);
    t.onclick = () => { s++; document.getElementById('game-score').innerText = `ì ìˆ˜: ${s}ì `; };
    setTimeout(() => { 
        clearInterval(timer); t.style.display='none'; btn.disabled = false;
        alert(`ê²Œì„ ì¢…ë£Œ! ${s}ì  íšë“ (XPë¡œë„ ì ë¦½ë©ë‹ˆë‹¤)`); 
        saveGameScore(s); // ê²Œì„ ë­í‚¹ ì €ì¥
        earnXP(s); // XP ë­í‚¹ ì €ì¥
    }, 10000);
}

// (ê¸°íƒ€ earnXP, promptForSettings, StateManager ë“±ì€ ì´ì „ ìµœì¢…ë³¸ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€)
function earnXP(amt) {
    const k = `${userGrade}-${userClass}-${userName}`;
    const d = JSON.parse(localStorage.getItem('total_xp_ranking') || '{}');
    if(!d[k]) d[k] = { totalXP: 0, name: userName };
    d[k].totalXP += amt;
    localStorage.setItem('total_xp_ranking', JSON.stringify(d));
    updateUserInfoDisplay();
}

const StateManager = {
    showScreen: function(id) { document.querySelectorAll('.card').forEach(c => c.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); updateUserInfoDisplay(); },
    loadData: async function(mode) { alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤..."); } // ì‹¤ì œ API ì½”ë“œëŠ” ì´ì „ë³¸ ì°¸ê³ 
};

function updateUserInfoDisplay() {
    const el = document.getElementById('user-info-display');
    const d = JSON.parse(localStorage.getItem('total_xp_ranking') || '{}');
    const xp = (d[`${userGrade}-${userClass}-${userName}`] || {}).totalXP || 0;
    if(userName) {
        el.innerHTML = `${userName}<br><div class="title-badge">í•´ëˆ„ë¦¬ ìƒˆì‹¹ ğŸŒ±</div>`;
        document.getElementById('xp-bar').style.width = Math.min((xp/1000)*100, 100) + '%';
        document.getElementById('xp-text').innerText = `XP: ${xp}`;
    }
}

document.addEventListener('DOMContentLoaded', () => { if(userName) StateManager.showScreen('portal'); });
</script>
</body>
</html>
