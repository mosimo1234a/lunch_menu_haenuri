<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>í•´ëˆ„ë¦¬ ì´ˆë“±í•™êµ 5í•™ë…„ ìš°ë¦¬ë“¤ì˜ ê³µê°„ ğŸ«</title>
<link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
<style>
    /* --- 1. CSS ë³€ìˆ˜ ë° ê¸°ë³¸ ì„¤ì • --- */
    :root {
        --color-apricot: #ffd9a8; --color-sky: #cceeff; --color-rose: #ffc9d4;
        --color-grass: #d2f6c9; --color-text-dark: #3a322b; 
        --color-card-bg: #ffffff; --color-border: #3a322b;
    }

    body {
        font-family: 'Jua', sans-serif;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        background-color: var(--color-apricot);
        color: var(--color-text-dark);
        background-image: url('data:image/svg+xml;utf8,<svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><circle cx="5" cy="5" r="1.5" fill="%23f6f0e9" opacity="0.8"/><path d="M15,15 L15,13 L15,11 L13,13 Z" fill="%23f6f0e9" opacity="0.6"/></svg>');
        background-size: 40px 40px;
    }

    /* --- 2. ì¹´ë“œ ë””ìì¸ --- */
    .card {
        background-color: var(--color-card-bg);
        border-radius: 35px;
        padding: 40px;
        border: 4px dashed var(--color-border);
        box-shadow: 6px 6px 0 0 var(--color-border); 
        text-align: center;
        width: 90%;
        max-width: 400px; 
        transform: rotate(-3deg);
        box-sizing: border-box;
    }
    
    p {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 30px;
        line-height: 1.2;
    }
    
    .date-text {
        font-size: 1.2rem; 
        font-weight: 600;
        margin-bottom: 10px; 
        color: var(--color-text-dark); 
        transform: rotate(1deg);
    }

    /* --- 3. ë²„íŠ¼ ë””ìì¸ --- */
    button {
        font-family: 'Jua', sans-serif;
        font-weight: bold;
        font-size: 1.2rem;
        padding: 12px 25px;
        margin: 8px;
        border-radius: 30px;
        border: 4px solid var(--color-border); 
        color: var(--color-border);
        cursor: pointer;
        box-shadow: 4px 4px 0px 0px var(--color-border);
        transform: rotate(2deg); 
        background-color: #fff;
        transition: all 0.1s; 
    }

    button:hover {
        transform: scale(1.02) rotate(2deg);
        box-shadow: 6px 6px 0px 0px var(--color-border);
    }

    button:active {
        transform: scale(0.97) rotate(1deg); 
        box-shadow: 2px 2px 0px 0px var(--color-border); 
    }

    #lunch-menu { 
        background-color: var(--color-rose); 
        transform: rotate(-4deg);
        width: 100%; 
    }
    #schedule-btn { 
        background-color: var(--color-grass); 
        transform: rotate(3deg);
        width: 100%; 
    }
    #timetable-btn { 
        background-color: var(--color-sky);
        width: 100%;
        transform: rotate(-1deg);
    }
    #yes_btn { background-color: var(--color-rose); transform: rotate(-4deg); }
    #no_btn { background-color: var(--color-grass); }
    #back_btn { background-color: var(--color-sky); }
    #settings-btn { 
        background-color: var(--color-apricot); 
        font-size:0.9rem; 
        padding: 10px 20px; 
        margin-top: 15px; 
        width: auto;
    }
    
    /* --- 4. ë©”ì‹œì§€ ë° í‘œ ì˜ì—­ --- */
    .hidden { display: none !important; }
    .message {
        font-size: 1.6rem;
        font-weight: bold;
        margin-top: 20px;
        color: var(--color-text-dark);
        margin-bottom: 20px;
    }

    /* --- 5. í‘œ (Table) ë””ìì¸ --- */
    #menu_table_area {
        margin-top: 20px;
        padding: 10px;
        border: 2px dashed var(--color-rose);
        border-radius: 15px;
        background-color: #fffbf5;
        width: 100%; 
        box-sizing: border-box;
    }
    #menu_table_area h3 {
        font-size: 1.3rem;
        margin-top: 0;
        margin-bottom: 10px;
        color: var(--color-rose);
        transform: rotate(-1deg);
    }
    #menu_table {
        width: 100%;
        border-collapse: collapse;
        font-size: 1rem;
    }
    #menu_table th, #menu_table td {
        border: 2px solid var(--color-border);
        padding: 8px 5px;
        text-align: center;
        background-color: #ffffff;
    }
    #menu_table th {
        background-color: var(--color-sky);
        color: var(--color-border);
        font-size: 1.1rem;
    }
</style>
</head>
<body>
<div id="question" class="card hidden">
    <p>í•´ëˆ„ë¦¬ ì´ˆë“±í•™êµ í•™ìƒì…ë‹ˆê¹Œ? ğŸ</p>
    <button id="yes_btn">ë„¤! ë§ìŠµë‹ˆë‹¤! ğŸ¥³</button>
    <button id="no_btn">ì•„ë‹™ë‹ˆë‹¤ ğŸ˜¥</button>
</div>

<div id="portal" class="card hidden">
    <p id="today-date-display" class="date-text"></p> 
    <p>ìš°ë¦¬ í•™êµ ì •ë³´ë¥¼ í™•ì¸í•©ë‹ˆë‹¤. ğŸ«</p>
    
    <button id="lunch-menu">ê¸‰ì‹ ë©”ë‰´ ğŸš</button>
    <button id="schedule-btn">í•™ì‚¬ ì¼ì • í™•ì¸ ğŸ—“ï¸</button>
    <button id="timetable-btn">ì˜¤ëŠ˜ ì‹œê°„í‘œ â°</button>
    
    <button id="settings-btn">í•™ë…„/ë°˜ ì„¤ì • âš™ï¸</button> 
</div>

<div id="message_area" class="card hidden">
    <p id="message_text" class="message hidden"></p> 
    
    <div id="dateNavigation" style="margin-bottom: 10px; width: 100%;">
        <div id="dayNavButtons" class="hidden" style="display: flex; justify-content: space-around;">
            <button id="prev_day" style="background-color: var(--color-grass); font-size: 1rem; padding: 8px 15px; flex-grow: 1; margin: 5px;">â¬…ï¸ ì´ì „ ë‚ ì§œ</button>
            <button id="next_day" style="background-color: var(--color-sky); font-size: 1rem; padding: 8px 15px; flex-grow: 1; margin: 5px;">ë‹¤ìŒ ë‚ ì§œ â¡ï¸</button>
        </div>
        <div id="monthNavButtons" class="hidden" style="display: flex; justify-content: space-around;">
            <button id="prev_month" style="background-color: var(--color-rose); font-size: 1rem; padding: 8px 15px; flex-grow: 1; margin: 5px;">âª ì´ì „ ë‹¬</button>
            <button id="next_month" style="background-color: var(--color-apricot); font-size: 1rem; padding: 8px 15px; flex-grow: 1; margin: 5px;">ë‹¤ìŒ ë‹¬ â©</button>
        </div>
    </div>
    
    <div id="menu_table_area" class="hidden">
        <p id="no-waste-message" class="hidden" style="color: #FF5733; font-size: 1.5rem; transform: rotate(2deg); margin-bottom: 15px; background-color: #fff8e1; padding: 5px; border-radius: 10px; border: 2px solid #FF5733;">
            âœ¨ ì˜¤ëŠ˜ì€ ì”ë°˜ ì—†ëŠ” ë‚ ! ëª¨ë‘ ê¹¨ë—ì´ ë¨¹ì–´ìš”! âœ¨
        </p>
        
        <h3>ì •ë³´ ì œëª©</h3>
        <table id="menu_table">
            </table>
    </div>

    <button id="back_btn">ì´ì „ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
</div>

<p id="creator-info">Made by ê¹€ëŒ€ì›</p>

<script>
// ----------------------------------------------------
// âœ¨ 1. ì„¤ì • ë° ë³€ìˆ˜ âœ¨
// ----------------------------------------------------

let currentDisplayDate = new Date();
let currentScreenMode = 'portal'; 

const NEIS_CONFIG = {
    KEY: "59ff63a46d7f41bf97464e3caf3a486c", 
    ATPT_OFCDC_SC_CODE: "B10", 
    SD_SCHUL_CODE: "7130255",  
    // âœ… ì‹œê°„í‘œ ì„œë¹„ìŠ¤ ID ìµœì¢… ìˆ˜ì • ë°˜ì˜
    TIME_TABLE_URL: "https://open.neis.go.kr/hub/elsTimetable",
    MEAL_URL: "https://open.neis.go.kr/hub/mealServiceDietInfo",
    SCHEDULE_URL: "https://open.neis.go.kr/hub/SchoolSchedule",
};

// ì‚¬ìš©ì ì„¤ì • (í•™ë…„/ë°˜)ì„ ë¡œì»¬ ì €ì¥ì†Œì—ì„œ ë¶ˆëŸ¬ì˜¤ê±°ë‚˜ ì„ì‹œ ê¸°ë³¸ê°’ ì„¤ì • (5í•™ë…„ 5ë°˜)
let userGrade = localStorage.getItem('user_grade') || '5'; 
let userClass = localStorage.getItem('user_class') || '5'; 


// ----------------------------------------------------
// âœ¨ 2. ì‚¬ìš©ì ì„¤ì • í•¨ìˆ˜ âœ¨
// ----------------------------------------------------

function saveSettings(grade, classNum) {
    localStorage.setItem('user_grade', grade);
    localStorage.setItem('user_class', classNum);
    userGrade = grade;
    userClass = classNum;
}

function promptForSettings() {
    const grade = prompt(`í˜„ì¬ ì €ì¥ëœ í•™ë…„: ${userGrade || 'ì—†ìŒ'}\nìƒˆ í•™ë…„ì„ ìˆ«ìë¡œ ì…ë ¥í•´ ì£¼ì„¸ìš” (ì˜ˆ: 5)`);
    if (grade === null) return; 
    
    const classNum = prompt(`í˜„ì¬ ì €ì¥ëœ ë°˜: ${userClass || 'ì—†ìŒ'}\nìƒˆ ë°˜ì„ ìˆ«ìë¡œ ì…ë ¥í•´ ì£¼ì„¸ìš” (ì˜ˆ: 5)`);
    if (classNum === null) return;

    if (grade && classNum && !isNaN(grade) && !isNaN(classNum)) {
        saveSettings(grade, classNum);
        alert(`ì„¤ì • ì™„ë£Œ! ${grade}í•™ë…„ ${classNum}ë°˜ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        return true;
    } else {
        alert("âŒ ì˜ëª»ëœ ì…ë ¥ì…ë‹ˆë‹¤. í•™ë…„ê³¼ ë°˜ì„ ìˆ«ìë¡œ ë‹¤ì‹œ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
        return false;
    }
}


// ----------------------------------------------------
// âœ¨ 3. API í˜¸ì¶œ í•¨ìˆ˜ âœ¨
// ----------------------------------------------------

// 3-1. ê¸‰ì‹ API (ì¼ë³„)
async function fetchMealDataFromAPI(dateObj) { 
    const YYYYMMDD = `${dateObj.getFullYear()}${String(dateObj.getMonth() + 1).padStart(2, '0')}${String(dateObj.getDate()).padStart(2, '0')}`;
    const apiUrl = `${NEIS_CONFIG.MEAL_URL}?KEY=${NEIS_CONFIG.KEY}&Type=json&pIndex=1&pSize=100` +
                   `&ATPT_OFCDC_SC_CODE=${NEIS_CONFIG.ATPT_OFCDC_SC_CODE}` +
                   `&SD_SCHUL_CODE=${NEIS_CONFIG.SD_SCHUL_CODE}&MLSV_YMD=${YYYYMMDD}`; 
                   
    try {
        const response = await fetch(apiUrl);
        const data = await response.json();

        if (data.mealServiceDietInfo) {
            let menuString = data.mealServiceDietInfo[1].row[0].DDISH_NM;
            let menuArray = menuString
                .split('<br/>')
                .map(item => item.replace(/\([0-9\.]+\)/g, '').trim())
                .filter(item => item.length > 0); 
            return { success: true, menu: menuArray };
        } else if (data.RESULT && data.RESULT.CODE === 'INFO-200') {
            return { error: `[ê³µì§€] ${dateObj.getMonth() + 1}ì›” ${dateObj.getDate()}ì¼ ê¸‰ì‹ ì •ë³´ëŠ” ì°¾ì„ ìˆ˜ ì—†ì–´ìš”. ğŸ¤”` };
        } else {
            return { error: `[ì—ëŸ¬] ê¸‰ì‹ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.` };
        }
    } catch (error) {
        return { error: `[ì—ëŸ¬] ê¸‰ì‹ API í†µì‹  ì˜¤ë¥˜: ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.` }; 
    }
}

// 3-2. í•™ì‚¬ ì¼ì • API (ì›”ë³„)
async function fetchScheduleDataFromAPI(dateObj) { 
    // í•´ë‹¹ ì›”ì˜ 1ì¼
    const startMonth = String(dateObj.getMonth() + 1).padStart(2, '0');
    const startDay = '01';
    const startDate = `${dateObj.getFullYear()}${startMonth}${startDay}`;
    
    // í•´ë‹¹ ì›”ì˜ ë§ˆì§€ë§‰ ë‚ 
    const lastDayOfMonth = new Date(dateObj.getFullYear(), dateObj.getMonth() + 1, 0).getDate();
    const endDate = `${dateObj.getFullYear()}${startMonth}${lastDayOfMonth}`;

    const apiUrl = `${NEIS_CONFIG.SCHEDULE_URL}?KEY=${NEIS_CONFIG.KEY}&Type=json&pIndex=1&pSize=100` +
                   `&ATPT_OFCDC_SC_CODE=${NEIS_CONFIG.ATPT_OFCDC_SC_CODE}` +
                   `&SD_SCHUL_CODE=${NEIS_CONFIG.SD_SCHUL_CODE}` +
                   `&AA_FROM_YMD=${startDate}&AA_TO_YMD=${endDate}`;
                   
    try {
        const response = await fetch(apiUrl);
        const data = await response.json();

        if (data.SchoolSchedule) {
            return { 
                success: true, 
                schedule: data.SchoolSchedule[1].row.map(item => ({ 
                    date: item.AA_YMD, 
                    content: item.EVENT_NM
                }))
            };
        } else if (data.RESULT && data.RESULT.CODE === 'INFO-200') {
            return { error: `[ê³µì§€] ${dateObj.getMonth() + 1}ì›” í•™ì‚¬ ì¼ì •ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”. ğŸ˜¥` };
        } else {
            return { error: `[ì—ëŸ¬] í•™ì‚¬ ì¼ì • ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.` };
        }
    } catch (error) {
        return { error: `[ì—ëŸ¬] í•™ì‚¬ ì¼ì • API í†µì‹  ì˜¤ë¥˜: ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.` }; 
    }
}


// 3-3. ì‹œê°„í‘œ API (ì¼ë³„)
async function fetchTimeTableDataFromAPI(dateObj, grade, classNum) { 
    const YYYYMMDD = `${dateObj.getFullYear()}${String(dateObj.getMonth() + 1).padStart(2, '0')}${String(dateObj.getDate()).padStart(2, '0')}`;
    
    const apiUrl = `${NEIS_CONFIG.TIME_TABLE_URL}?KEY=${NEIS_CONFIG.KEY}&Type=json&pIndex=1&pSize=100` +
                   `&ATPT_OFCDC_SC_CODE=${NEIS_CONFIG.ATPT_OFCDC_SC_CODE}` +
                   `&SD_SCHUL_CODE=${NEIS_CONFIG.SD_SCHUL_CODE}` +
                   `&AY=${dateObj.getFullYear()}` + 
                   `&TI_FROM_YMD=${YYYYMMDD}&TI_TO_YMD=${YYYYMMDD}` + 
                   `&GRADE=${grade}&CLASS_NM=${classNum}`; 
                   
    try {
        const response = await fetch(apiUrl);
        const data = await response.json();

        // âœ… 'elsTimetable' í‚¤ë¡œ ë°ì´í„° í™•ì¸
        if (data.elsTimetable) { 
            return { 
                success: true, 
                schedule: data.elsTimetable[1].row.map(item => ({ 
                    period: item.PERIO, 
                    subject: item.ITRT_CNTNT
                }))
            };
        } else if (data.RESULT && data.RESULT.CODE === 'INFO-200') {
            // âœ… ì‹œê°„í‘œê°€ ì—†ëŠ” ë‚  ì²˜ë¦¬ë¥¼ ìœ„í•´ íŠ¹ë³„í•œ ì—ëŸ¬ ì½”ë“œ ë°˜í™˜
            return { error: `INFO-200` }; 
        } else {
            return { error: `[ì—ëŸ¬] ì‹œê°„í‘œ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (NEIS í‚¤ ì˜¤ë¥˜)` };
        }
    } catch (error) {
        return { error: `[ì—ëŸ¬] ì‹œê°„í‘œ API í†µì‹  ì˜¤ë¥˜: ë„¤íŠ¸ì›Œí¬/CORS ë¬¸ì œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.` }; 
    }
}


// ----------------------------------------------------
// âœ¨ 4. ë°ì´í„° í‘œì‹œ í•¨ìˆ˜ âœ¨
// ----------------------------------------------------

function displayMealAsTable(menuArray) { 
    const tableBody = document.querySelector('#menu_table');
    tableBody.innerHTML = ''; 
    const headerRow = tableBody.insertRow();
    headerRow.innerHTML = '<th>No.</th><th>ë©”ë‰´</th>';

    menuArray.forEach((item, index) => {
        const row = tableBody.insertRow();
        const cellNo = row.insertCell();
        const cellMenu = row.insertCell();
        cellNo.textContent = index + 1;
        cellMenu.textContent = item;
    });
}

// í•™ì‚¬ ì¼ì • ì¶œë ¥ í•¨ìˆ˜
function displayScheduleAsList(scheduleArray, year, month) {
    const tableBody = document.querySelector('#menu_table');
    tableBody.innerHTML = ''; 
    
    document.querySelector('#menu_table_area h3').textContent = `${year}ë…„ ${month}ì›” í•™ì‚¬ ì¼ì •`; 

    const headerRow = tableBody.insertRow();
    headerRow.innerHTML = '<th>ë‚ ì§œ</th><th>ì¼ì • ë‚´ìš©</th>';

    scheduleArray.sort((a, b) => a.date.localeCompare(b.date));

    scheduleArray.forEach(item => {
        const row = tableBody.insertRow();
        const cellDate = row.insertCell();
        const cellContent = row.insertCell();
        
        const formattedDate = `${item.date.substring(4, 6)}/${item.date.substring(6, 8)}`;
        
        cellDate.textContent = formattedDate;
        cellDate.style.width = '30%';
        cellDate.style.color = 'var(--color-rose)';
        cellDate.style.fontWeight = 'bold';
        cellContent.textContent = item.content;
    });
}

// ì‹œê°„í‘œ ì¶œë ¥ í•¨ìˆ˜
function displayTimeTable(timeTableArray, grade, classNum) {
    const tableBody = document.querySelector('#menu_table');
    tableBody.innerHTML = ''; 

    document.querySelector('#menu_table_area h3').textContent = `${grade}í•™ë…„ ${classNum}ë°˜ ì˜¤ëŠ˜ ì‹œê°„í‘œ`; 

    const headerRow = tableBody.insertRow(0);
    headerRow.innerHTML = '<th>êµì‹œ</th><th>ê³¼ëª©</th>';
    
    timeTableArray.forEach(item => {
        const row = tableBody.insertRow();
        const cellPeriod = row.insertCell();
        const cellSubject = row.insertCell();
        
        cellPeriod.innerHTML = `<span style="font-size:1.1rem; color: var(--color-rose); font-weight:bold;">${item.period}êµì‹œ</span>`;
        cellSubject.textContent = item.subject;
        cellSubject.style.textAlign = 'center';
    });
}

function displayTodayDate() {
    const today = currentDisplayDate; 
    const year = today.getFullYear();
    const month = today.getMonth() + 1; 
    const date = today.getDate();
    const day = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][today.getDay()];
    
    const todayActual = new Date();
    const isToday = todayActual.toDateString() === today.toDateString(); 
    
    let datePrefix = "ì˜¤ëŠ˜ì˜";
    let formattedDate = '';

    if (currentScreenMode === 'meal' || currentScreenMode === 'timetable') {
        datePrefix = isToday ? "ì˜¤ëŠ˜ì˜" : `${month}ì›” ${date}ì¼ì˜`;
        let subjectText = currentScreenMode === 'timetable' 
            ? `${userGrade || '?'}í•™ë…„ ${userClass || '?'}ë°˜ì˜` 
            : '';
        formattedDate = `${subjectText} ${datePrefix} ì •ë³´ (${year}.${String(month).padStart(2, '0')}.${String(date).padStart(2, '0')} (${day}))`;
    } else if (currentScreenMode === 'schedule') {
        formattedDate = `${year}ë…„ ${month}ì›”ì˜ ì£¼ìš” í•™ì‚¬ ì¼ì •`;
    }

    const dateElement = document.getElementById('today-date-display');
    if (dateElement) {
        dateElement.textContent = formattedDate;
    }
}


// ----------------------------------------------------
// âœ¨ 5. UI ë° ìƒíƒœ ê´€ë¦¬ âœ¨
// ----------------------------------------------------

const UI = {
    screens: { 
        question: document.getElementById("question"), 
        portal: document.getElementById("portal"), 
        message_area: document.getElementById("message_area") 
    }, 
    elements: { 
        body: document.body, 
        message_text: document.getElementById("message_text"), 
        back_btn: document.getElementById("back_btn"), 
        yes_btn: document.getElementById("yes_btn"), 
        no_btn: document.getElementById("no_btn"),
        lunch_menu_btn: document.getElementById("lunch-menu"),
        schedule_btn: document.getElementById("schedule-btn"), 
        timetable_btn: document.getElementById("timetable-btn"), 
        settings_btn: document.getElementById("settings-btn"),
        menu_table_area: document.getElementById("menu_table_area"),
        
        day_nav_buttons: document.getElementById("dayNavButtons"),
        month_nav_buttons: document.getElementById("monthNavButtons"),
        prev_btn: document.getElementById("prev_day"), 
        next_btn: document.getElementById("next_day"),
        prev_month_btn: document.getElementById("prev_month"), 
        next_month_btn: document.getElementById("next_month"),

        no_waste_msg: document.getElementById("no-waste-message"), 
    }
};


const StateManager = {
    // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ì´ˆê¸°í™” í—¬í¼
    resetNavButtons: function() {
        UI.elements.day_nav_buttons.classList.add("hidden");
        UI.elements.month_nav_buttons.classList.add("hidden");
        UI.elements.no_waste_msg.classList.add("hidden");
        UI.elements.menu_table_area.classList.add("hidden"); 
        UI.elements.message_text.classList.add("hidden"); 
    },

    showScreen: function(screenId, stateClass = '') {
        Object.values(UI.screens).forEach(el => el.classList.add("hidden"));
        UI.screens[screenId].classList.remove("hidden");
        
        UI.elements.body.classList.remove("access-state", "deny-state");
        if (stateClass) UI.elements.body.classList.add(stateClass);
        
        if (screenId === 'message_area') {
            this.resetNavButtons();
        }

        displayTodayDate();
    },
    
    // âœ… ë‚ ì§œ/ì›” ì´ë™ ë° í™”ë©´ ìƒˆë¡œê³ ì¹¨ í•¨ìˆ˜
    changeDateAndReload: function(amount, unit) {
        if (unit === 'month') {
            currentDisplayDate.setMonth(currentDisplayDate.getMonth() + amount);
        } else { // 'day' or default
            currentDisplayDate.setDate(currentDisplayDate.getDate() + amount);
        }

        if (currentScreenMode === 'meal') {
            this.showMealMenu(null, 'access-state');
        } else if (currentScreenMode === 'schedule') {
            this.showSchedule();
        } else if (currentScreenMode === 'timetable') {
            this.showTimeTable();
        }
    },

    // 5-1. ê¸‰ì‹ í™”ë©´ (ì¼ë³„ ì´ë™)
    showMealMenu: async function(prevId, stateClass) {
        currentScreenMode = 'meal';
        this.showScreen("message_area", 'access-state');
        
        UI.elements.day_nav_buttons.classList.remove("hidden"); 
        
        UI.elements.menu_table_area.classList.add("hidden");
        UI.elements.message_text.classList.remove("hidden"); 
        UI.elements.message_text.textContent = "ê¸‰ì‹ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤... â³";
        
        const result = await fetchMealDataFromAPI(currentDisplayDate); 
        
        if (result.success) {
            displayMealAsTable(result.menu);
            UI.elements.message_text.classList.add("hidden"); 
            UI.elements.menu_table_area.classList.remove("hidden"); 
            
            const dayOfWeek = currentDisplayDate.getDay();
            if (dayOfWeek === 3 || dayOfWeek === 5) { 
                UI.elements.no_waste_msg.classList.remove("hidden");
            }
        } else {
            UI.elements.message_text.textContent = result.error;
            UI.elements.message_text.classList.remove("hidden"); 
            UI.elements.menu_table_area.classList.add("hidden"); 
        }
        
        UI.elements.back_btn.onclick = () => {
            currentDisplayDate = new Date(); 
            this.showScreen("portal", 'access-state');
        }
    },

    // 5-2. í•™ì‚¬ ì¼ì • í™”ë©´ (ì›”ë³„ ì´ë™)
    showSchedule: async function() {
        currentScreenMode = 'schedule';
        this.showScreen("message_area", 'access-state');

        UI.elements.month_nav_buttons.classList.remove("hidden"); // ì›”ë³„ ë²„íŠ¼ í‘œì‹œ

        UI.elements.menu_table_area.classList.add("hidden");
        UI.elements.message_text.classList.remove("hidden"); 
        UI.elements.message_text.textContent = `${currentDisplayDate.getFullYear()}ë…„ ${currentDisplayDate.getMonth() + 1}ì›” í•™ì‚¬ ì¼ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤... â³`;

        const result = await fetchScheduleDataFromAPI(currentDisplayDate); 
        
        if (result.success) {
            displayScheduleAsList(result.schedule, currentDisplayDate.getFullYear(), currentDisplayDate.getMonth() + 1);
            UI.elements.message_text.classList.add("hidden");
            UI.elements.menu_table_area.classList.remove("hidden"); 
        } else {
            UI.elements.message_text.textContent = result.error;
            UI.elements.message_text.classList.remove("hidden"); 
            UI.elements.menu_table_area.classList.add("hidden"); 
        }
        
        UI.elements.back_btn.onclick = () => {
            currentDisplayDate = new Date(); 
            this.showScreen("portal", 'access-state');
        }
    },
    
    // 5-3. ì‹œê°„í‘œ í™”ë©´ (ì¼ë³„ ì´ë™ + ë°ì´í„° ì—†ìŒ ì²˜ë¦¬)
    showTimeTable: async function() {
        currentScreenMode = 'timetable';
        this.showScreen("message_area", 'access-state');
        
        UI.elements.day_nav_buttons.classList.remove("hidden"); 

        if (!userGrade || !userClass) {
            UI.elements.message_text.classList.remove("hidden"); 
            UI.elements.message_text.textContent = "âš ï¸ ì‹œê°„í‘œë¥¼ ë³´ê¸° ìœ„í•´ í•™ë…„/ë°˜ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. ì´ì „ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ì„œ 'í•™ë…„/ë°˜ ì„¤ì •' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.";
            UI.elements.menu_table_area.classList.add("hidden"); 
            
            UI.elements.back_btn.onclick = () => { this.showScreen("portal", 'access-state'); }
            return; 
        }

        UI.elements.menu_table_area.classList.add("hidden");
        UI.elements.message_text.classList.remove("hidden"); 
        UI.elements.message_text.textContent = `${userGrade}í•™ë…„ ${userClass}ë°˜ ì‹œê°„í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤... â³`;
        
        const result = await fetchTimeTableDataFromAPI(currentDisplayDate, userGrade, userClass); 
        
        if (result.success) {
            displayTimeTable(result.schedule, userGrade, userClass);
            UI.elements.message_text.classList.add("hidden");
            UI.elements.menu_table_area.classList.remove("hidden"); 
        } else {
            // âœ… ì‹œê°„í‘œ ì—†ëŠ” ë‚  ì²˜ë¦¬ (INFO-200)
            const dateStr = `${currentDisplayDate.getMonth() + 1}ì›” ${currentDisplayDate.getDate()}ì¼`;
            let errorMessage = '';

            if (result.error === 'INFO-200') {
                 errorMessage = `[ê³µì§€] ${dateStr}ì€ íœ´ì¼ì´ê±°ë‚˜, ${userGrade}í•™ë…„ ${userClass}ë°˜ì˜ ì‹œê°„í‘œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”. ğŸ¤”`;
            } else {
                 errorMessage = result.error;
            }
            
            UI.elements.message_text.textContent = errorMessage;
            UI.elements.message_text.classList.remove("hidden"); 
            UI.elements.menu_table_area.classList.add("hidden"); 
        }
        
        UI.elements.back_btn.onclick = () => {
            currentDisplayDate = new Date(); 
            this.showScreen("portal", 'access-state');
        }
    },
    
    // 5-4. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    initEventListeners: function() {
        // Yes/No ë²„íŠ¼
        UI.elements.yes_btn.addEventListener("click", () => {
            currentDisplayDate = new Date(); 
            this.showScreen("portal", "access-state");
        });
        UI.elements.no_btn.addEventListener("click", () => {
            this.showScreen("message_area", "deny-state");
            UI.elements.message_text.textContent = "ì•„ì§ í•´ëˆ„ë¦¬ ì¹œêµ¬ê°€ ì•„ë‹ˆêµ°ìš”! ë‹¤ìŒì— ê¼­ ë§Œë‚˜ìš”! ğŸ‘‹";
            UI.elements.back_btn.onclick = () => this.showScreen("question", "deny-state");
        });
        
        // ê¸°ëŠ¥ ë²„íŠ¼
        UI.elements.lunch_menu_btn.addEventListener("click", () => {
            this.showMealMenu("portal", "access-state");
        });
        UI.elements.schedule_btn.addEventListener("click", () => {
            this.showSchedule();
        });
        UI.elements.timetable_btn.addEventListener("click", () => {
            this.showTimeTable();
        });
        
        // ì„¤ì • ë²„íŠ¼
        UI.elements.settings_btn.addEventListener("click", () => {
            promptForSettings();
        });

        // ì¼ë³„ ë‚ ì§œ ì´ë™ ë²„íŠ¼ (ê¸‰ì‹, ì‹œê°„í‘œ)
        UI.elements.prev_btn.addEventListener("click", () => {
            this.changeDateAndReload(-1, 'day'); 
        });
        UI.elements.next_btn.addEventListener("click", () => {
            this.changeDateAndReload(1, 'day'); 
        });

        // ì›”ë³„ ë‚ ì§œ ì´ë™ ë²„íŠ¼ (í•™ì‚¬ ì¼ì •)
        UI.elements.prev_month_btn.addEventListener("click", () => {
            this.changeDateAndReload(-1, 'month'); 
        });
        UI.elements.next_month_btn.addEventListener("click", () => {
            this.changeDateAndReload(1, 'month'); 
        });
    }
};

// --- ì‹œìŠ¤í…œ ì´ˆê¸°í™” (ì•± ì‹œì‘) ---
StateManager.initEventListeners();
StateManager.showScreen("question", "deny-state"); 
</script>
</body>
</html>
