<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>í•´ëˆ„ë¦¬ ì´ˆë“±í•™êµ 5-5 ìš°ë¦¬ë“¤ì˜ ê³µê°„ ğŸ«</title>
<link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
<style>
    :root {
        --color-sky: #a8d5ff; --color-rose: #ffc9d4; --color-apricot: #ffd9a8;
        --color-grass: #d2f6c9; --color-gold: #FFD700; --color-border: #3a322b;
    }

    body {
        font-family: 'Jua', sans-serif; background-color: var(--color-sky);
        display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0;
        background-image: radial-gradient(circle at 50% 50%, white 2.5px, transparent 2.5px),
                          radial-gradient(circle at 20% 80%, white 3px, transparent 3px);
        background-size: 150px 150px, 250px 250px; animation: snow 12s linear infinite; overflow-x: hidden;
    }
    @keyframes snow { 0% { background-position: 0 0, 0 0; } 100% { background-position: 60px 1000px, -60px 1000px; } }

    .card {
        background: white; border-radius: 35px; padding: 30px; width: 92%; max-width: 400px;
        border: 4px dashed var(--color-border); box-shadow: 6px 6px 0 var(--color-border);
        margin: 15px; text-align: center; box-sizing: border-box; transform: rotate(-1deg); position: relative;
    }

    #user-info-display {
        font-size: 1.2rem; background-color: #fff8e1; border-radius: 15px; padding: 10px;
        border: 2.5px solid var(--color-gold); margin-bottom: 10px;
    }
    .title-badge { display: inline-block; padding: 2px 10px; border-radius: 10px; background-color: #333; color: var(--color-gold); font-size: 0.85rem; margin-top: 5px; }

    #xp-bar-container {
        width: 100%; height: 18px; background-color: #eee; border-radius: 10px;
        margin-bottom: 20px; overflow: hidden; border: 2px solid var(--color-border); position: relative;
    }
    #xp-bar { height: 100%; width: 0%; background-color: var(--color-gold); transition: width 0.6s; }
    #xp-text { position: absolute; width: 100%; text-align: center; line-height: 18px; font-size: 0.8rem; font-weight: bold; }

    button {
        font-family: 'Jua', sans-serif; font-size: 1.1rem; padding: 12px; margin: 6px 0; width: 100%;
        border-radius: 30px; border: 4px solid var(--color-border); cursor: pointer;
        background: white; box-shadow: 4px 4px 0 var(--color-border); transition: 0.1s;
    }
    button:active { transform: scale(0.96); box-shadow: 2px 2px 0 var(--color-border); }

    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid var(--color-border); padding: 8px; text-align: center; font-size: 0.9rem; }
    
    .title-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
    .locked { filter: grayscale(1); opacity: 0.5; }
    .hidden { display: none !important; }

    #roulette-wrap { position: relative; width: 200px; height: 200px; margin: 15px auto; }
    #roulette {
        width: 100%; height: 100%; border-radius: 50%; border: 4px solid var(--color-border);
        background: conic-gradient(#ffadad 0% 10%, #ffd6a5 10% 30%, #fff9c4 30% 60%, #caffbf 60% 85%, #9bf6ff 85% 95%, var(--color-gold) 95% 100%);
        transition: transform 4s cubic-bezier(0.15, 0, 0.15, 1);
    }
    #pin { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width:0; height:0; border-left:12px solid transparent; border-right:12px solid transparent; border-top:25px solid #ff4444; z-index:10; }
</style>
</head>
<body>

<div id="portal" class="card">
    <div id="user-info-display">ì •ë³´ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”</div>
    <div id="xp-bar-container"><div id="xp-bar"></div><div id="xp-text"></div></div>
    
    <button onclick="StateManager.loadData('meal')" style="background-color: var(--color-rose);">ê¸‰ì‹ ë©”ë‰´ ğŸš</button>
    <button onclick="StateManager.loadData('timetable')" style="background-color: #cceeff;">ì˜¤ëŠ˜ ì‹œê°„í‘œ â°</button>
    <button onclick="StateManager.showScreen('roulette-screen')" style="background-color: var(--color-gold);">í–‰ìš´ì˜ ëŒë¦¼íŒ (5íšŒ) ğŸ¡</button>
    <button onclick="showTitleList()" style="background-color: #e1f5fe;">ë‚˜ì˜ ì¹­í˜¸ ëª©ë¡ ğŸ–ï¸</button>
    <button onclick="showRanking('xp')" style="background-color: #d2f6c9;">XP ë­í‚¹ ğŸ†</button>
    <button onclick="showRanking('game')" style="background-color: #ffccbc;">ë¯¸ë‹ˆê²Œì„ ë­í‚¹ ğŸ¥‡</button>
    <button onclick="StateManager.showScreen('minigame-screen')" style="background-color: var(--color-apricot);">ì„ ë¬¼ í›”ì¹˜ê¸° ê²Œì„ ğŸ®</button>
    
    <button id="inquiry-btn" class="hidden" onclick="StateManager.showScreen('inquiry-screen')" style="background-color: #e1bee7;">ìš´ì˜ì ë¬¸ì˜ âœ‰ï¸</button>
    <button onclick="promptForSettings()" style="font-size: 0.8rem; width: auto; margin-top: 15px;">ì •ë³´ ì„¤ì • âš™ï¸</button>
</div>

<div id="message_area" class="card hidden">
    <p id="display-title" style="font-size: 1.5rem;"></p>
    <div style="max-height: 250px; overflow-y: auto;"><table id="menu_table"></table></div>
    <button onclick="StateManager.showScreen('portal')" style="margin-top:15px;">ë’¤ë¡œ ê°€ê¸°</button>
</div>

<div id="ranking-screen" class="card hidden">
    <p id="rank-title" style="font-size: 1.5rem;"></p>
    <div style="max-height: 250px; overflow-y: auto;"><table id="rank-table"></table></div>
    <button onclick="StateManager.showScreen('portal')" style="margin-top:10px;">ëŒì•„ê°€ê¸°</button>
</div>

<div id="roulette-screen" class="card hidden">
    <p style="font-size: 1.5rem;">ğŸ¡ í–‰ìš´ì˜ ë£°ë ›</p>
    <p id="chance-text" style="font-size: 1rem; color: #ff5252;">ë‚¨ì€ ê¸°íšŒ: 5ë²ˆ</p>
    <div id="roulette-wrap"><div id="pin"></div><div id="roulette"></div></div>
    <button id="spin-btn" onclick="spinRoulette()" style="background-color: #ff5252; color: white;">ëŒë¦¬ê¸°!! ğŸš€</button>
    <button onclick="StateManager.showScreen('portal')">ëŒì•„ê°€ê¸°</button>
</div>

<div id="minigame-screen" class="card hidden">
    <p style="font-size: 1.5rem;">ğŸ ì„ ë¬¼ í›”ì¹˜ê¸°</p>
    <div id="game-area" style="width:100%; height:160px; background:#e0f2ff; position:relative; overflow:hidden; border:3px solid var(--color-border); border-radius:20px;">
        <span id="thief" style="position:absolute; font-size:3rem; cursor:pointer; display:none; user-select:none;">ğŸ…</span>
    </div>
    <p id="game-score">ì ìˆ˜: 0ì </p>
    <button onclick="startThiefGame()">ê²Œì„ ì‹œì‘!</button>
    <button onclick="StateManager.showScreen('portal')">ê·¸ë§Œí•˜ê¸°</button>
</div>

<div id="title-screen" class="card hidden">
    <p style="font-size: 1.5rem;">ğŸ–ï¸ ë‚˜ì˜ ì¹­í˜¸</p>
    <div id="title-container" style="max-height: 250px; overflow-y: auto; text-align: left;"></div>
    <button onclick="StateManager.showScreen('portal')" style="margin-top:15px;">ë‹«ê¸°</button>
</div>

<div id="inquiry-screen" class="card hidden">
    <p style="font-size: 1.5rem;">âœ‰ï¸ ìš´ì˜ì ë¬¸ì˜</p>
    <textarea id="inquiry-content" style="width:100%; height:100px; padding:10px; border-radius:15px; border:3px solid var(--color-border); font-family:'Jua';" placeholder="ê±´ì˜ ë‚´ìš©ì„ ì ì–´ì£¼ì„¸ìš”."></textarea>
    <button onclick="alert('ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!'); StateManager.showScreen('portal')" style="background-color: var(--color-rose); margin-top:10px;">ë³´ë‚´ê¸° ğŸš€</button>
    <button onclick="StateManager.showScreen('portal')">ì·¨ì†Œ</button>
</div>

<script>
// --- [ë°ì´í„° ì„¤ì •: ì›ë³¸ ë¡œì§ ìœ ì§€] ---
const ADMIN_CONF = { g: '5', c: '5', n: '1', name: 'ê°•ë¯¼ì¤€', pw: 'minjun55' }; 
const OPERATOR_CONF = { g: '5', c: '5', n: '4', name: 'ê¹€ëŒ€ì›', pw: 'eodnjs14' }; 
const NEIS_CONF = { KEY: "59ff63a46d7f41bf97464e3caf3a486c", ATPT: "B10", SD: "7130255" };
const TITLE_DB = { 'sprout': 'í•´ëˆ„ë¦¬ ìƒˆì‹¹ ğŸŒ±', 'explorer': 'ì •ë³´ íƒí—˜ê°€ ğŸ§­', 'santa': 'ğŸ… ì‚°íƒ€ì˜ ì¡°ìˆ˜', 'rudolph': 'ğŸ¦Œ ë£¨ëŒí”„ ì½”', 'gift': 'ğŸ ì„ ë¬¼ ë„ë‘‘' };

let userName = localStorage.getItem('user_name') || '';
let userGrade = localStorage.getItem('user_grade') || '';
let userClass = localStorage.getItem('user_class') || '';
let role = localStorage.getItem('user_role') || 'user';
let myTitles = JSON.parse(localStorage.getItem('my_titles') || '["sprout"]');
let activeTitle = localStorage.getItem('active_title') || 'sprout';
let curRot = 0;

// --- [ì •ë³´ ì„¤ì •: ì›ë³¸ ë°©ì‹] ---
function promptForSettings() {
    const g = prompt("í•™ë…„", "5"), c = prompt("ë°˜", "5"), n = prompt("ë²ˆí˜¸", "1"), nm = prompt("ì´ë¦„", "ì´ë¦„");
    if(!g || !c || !n || !nm) return;
    let r = 'user';
    if(nm === ADMIN_CONF.name && prompt("ê´€ë¦¬ì ë¹„ë²ˆ") === ADMIN_CONF.pw) r = 'admin';
    else if(nm === OPERATOR_CONF.name && prompt("ìš´ì˜ì ë¹„ë²ˆ") === OPERATOR_CONF.pw) r = 'operator';
    localStorage.setItem('user_grade', g); localStorage.setItem('user_class', c);
    localStorage.setItem('user_name', nm); localStorage.setItem('user_role', r);
    location.reload();
}

// --- [UI ì—…ë°ì´íŠ¸] ---
function updateUI() {
    const el = document.getElementById('user-info-display');
    const xpRank = JSON.parse(localStorage.getItem('total_xp_ranking') || '{}');
    const xp = (xpRank[`${userGrade}-${userClass}-${userName}`] || {}).totalXP || 0;
    if(userName) {
        let tag = (role === 'admin' || role === 'operator') ? " [âš™ï¸ ìš´ì˜ì§„]" : "";
        el.innerHTML = `${userName}${tag}<br><div class="title-badge">${TITLE_DB[activeTitle]}</div>`;
        document.getElementById('xp-bar').style.width = Math.min((xp/1000)*100, 100) + '%';
        document.getElementById('xp-text').innerText = `XP: ${xp} / 1000`;
        if(role === 'admin' || role === 'operator') document.getElementById('inquiry-btn').classList.remove('hidden');
    }
}

// --- [í•µì‹¬ ê¸°ëŠ¥: ì›ë³¸ ë¡œì§] ---
const StateManager = {
    showScreen: function(id) { document.querySelectorAll('.card').forEach(c => c.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); updateUI(); },
    loadData: async function(mode) {
        this.showScreen('message_area');
        const table = document.getElementById('menu_table');
        const title = document.getElementById('display-title');
        title.innerText = mode === 'meal' ? "ì˜¤ëŠ˜ì˜ ê¸‰ì‹ ğŸ±" : "ì˜¤ëŠ˜ ì‹œê°„í‘œ ğŸ“…";
        table.innerHTML = "<tr><td>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>";
        let ymd = new Date().toISOString().split('T')[0].replace(/-/g, '');
        let url = mode === 'meal' ? `https://open.neis.go.kr/hub/mealServiceDietInfo?KEY=${NEIS_CONF.KEY}&Type=json&ATPT_OFCDC_SC_CODE=${NEIS_CONF.ATPT}&SD_SCHUL_CODE=${NEIS_CONF.SD}&MLSV_YMD=${ymd}` 
                : `https://open.neis.go.kr/hub/elsTimetable?KEY=${NEIS_CONF.KEY}&Type=json&ATPT_OFCDC_SC_CODE=${NEIS_CONF.ATPT}&SD_SCHUL_CODE=${NEIS_CONF.SD}&GRADE=${userGrade}&CLASS_NM=${userClass}&ALL_TI_YMD=${ymd}`;
        try {
            const r = await fetch(url); const d = await r.json(); table.innerHTML = "";
            if(mode === 'meal' && d.mealServiceDietInfo) {
                d.mealServiceDietInfo[1].row[0].DDISH_NM.split('<br/>').forEach(m => { table.insertRow().insertCell().innerText = m.replace(/\([0-9\.]+\)/g, ''); });
            } else if(mode === 'timetable' && d.elsTimetable) {
                d.elsTimetable[1].row.forEach(s => { let tr = table.insertRow(); tr.insertCell().innerText = s.PERIO+"êµì‹œ"; tr.insertCell().innerText = s.ITRT_CNTNT; });
            } else { table.innerHTML = "<tr><td>ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>"; }
        } catch(e) { table.innerHTML = "<tr><td>ì—°ê²° ì˜¤ë¥˜</td></tr>"; }
    }
};

function earnXP(amt) {
    const k = `${userGrade}-${userClass}-${userName}`;
    const d = JSON.parse(localStorage.getItem('total_xp_ranking') || '{}');
    if(!d[k]) d[k] = { totalXP: 0, name: userName };
    d[k].totalXP += amt;
    localStorage.setItem('total_xp_ranking', JSON.stringify(d));
}

function showRanking(type) {
    StateManager.showScreen('ranking-screen');
    const title = document.getElementById('rank-title');
    const table = document.getElementById('rank-table');
    title.innerText = type === 'xp' ? "ğŸ† ì „ì²´ XP ë­í‚¹" : "ğŸ¥‡ ë¯¸ë‹ˆê²Œì„ ë­í‚¹";
    const key = type === 'xp' ? 'total_xp_ranking' : 'game_ranking';
    const data = JSON.parse(localStorage.getItem(key) || '{}');
    const sorted = Object.values(data).sort((a,b) => (b.totalXP || b.score) - (a.totalXP || a.score));
    table.innerHTML = "<tr><th>ìˆœìœ„</th><th>ì´ë¦„</th><th>ì ìˆ˜</th></tr>" + 
        sorted.map((u, i) => `<tr><td>${i+1}</td><td>${u.name}</td><td>${u.totalXP || u.score}</td></tr>`).join('');
}

function showTitleList() {
    StateManager.showScreen('title-screen');
    const cont = document.getElementById('title-container'); cont.innerHTML = "";
    Object.keys(TITLE_DB).forEach(id => {
        const isOwned = myTitles.includes(id);
        const div = document.createElement('div'); div.className = `title-item ${isOwned ? '' : 'locked'}`;
        div.innerHTML = `<span>${TITLE_DB[id]}</span>${isOwned ? `<button onclick="activeTitle='${id}';localStorage.setItem('active_title','${id}');alert('ì¥ì°©!');StateManager.showScreen('portal');" style="width:auto;padding:5px 10px;">ì¥ì°©</button>` : 'ğŸ”’'}`;
        cont.appendChild(div);
    });
}

function spinRoulette() {
    let ch = parseInt(localStorage.getItem('chances') || '5');
    if(ch <= 0) return alert("ë‚´ì¼ ë‹¤ì‹œ ì˜¤ì„¸ìš”!");
    localStorage.setItem('chances', --ch);
    document.getElementById('chance-text').innerText = `ë‚¨ì€ ê¸°íšŒ: ${ch}ë²ˆ`;
    const rand = Math.random() * 360 + 1440; curRot += rand;
    document.getElementById('roulette').style.transform = `rotate(${curRot}deg)`;
    setTimeout(() => { earnXP(50); alert("50 XP íšë“!"); updateUI(); }, 4000);
}

function startThiefGame() {
    let s = 0; const t = document.getElementById('thief'); t.style.display = 'block';
    let loop = setInterval(() => { t.style.top = Math.random()*70+'%'; t.style.left = Math.random()*80+'%'; }, 800);
    t.onclick = () => { s++; document.getElementById('game-score').innerText = `ì ìˆ˜: ${s}ì `; };
    setTimeout(() => {
        clearInterval(loop); t.style.display = 'none'; alert(`ì¢…ë£Œ! ${s}ì  íšë“`);
        earnXP(s);
        const gr = JSON.parse(localStorage.getItem('game_ranking') || '{}');
        const k = `${userGrade}-${userClass}-${userName}`;
        if(!gr[k] || gr[k].score < s) gr[k] = { name: userName, score: s };
        localStorage.setItem('game_ranking', JSON.stringify(gr));
        updateUI();
    }, 10000);
}

window.onload = () => { updateUI(); };
</script>
</body>
</html>
